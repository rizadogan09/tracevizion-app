<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TraceVizion Pro - Intelligent Trading Assistant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
      color: #e2e8f0;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    /* Main App Container */
    .app-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      background: rgba(10, 14, 26, 0.6);
      min-height: 100vh;
      box-shadow: 0 0 80px rgba(0, 0, 0, 0.4);
    }
    
    .header-bar {
      background: rgba(15, 20, 25, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(30, 41, 59, 0.5);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .logo {
      height: 36px;
      width: auto;
      min-width: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo svg {
      height: 100%;
      width: auto;
      filter: drop-shadow(0 2px 8px rgba(0, 207, 200, 0.3));
    }
    
    .logo svg:hover {
      filter: drop-shadow(0 4px 12px rgba(0, 207, 200, 0.5));
      transition: filter 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .logo {
        min-width: 160px;
      }
      .logo svg text {
        font-size: 14px;
      }
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .account-info {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 6px 12px;
      background: #1e293b;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .balance {
      font-weight: 600;
    }
    
    .balance.profit { color: #10b981; }
    .balance.loss { color: #ef4444; }
    .balance.neutral { color: #94a3b8; }
    
    .tab-bar {
      background: #0f1419;
      border-bottom: 1px solid #1e293b;
      display: flex;
      gap: 2px;
      padding: 0 20px;
    }
    
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: #94a3b8;
    }
    
    .tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }
    
    .module {
      display: none !important;
      padding: 20px;
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      box-sizing: border-box;
    }
    
    .module.active {
      display: block !important;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      width: 100%;
    }
    
    @media (min-width: 1200px) {
      .dashboard {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
    
    .panel {
      background: rgba(15, 20, 25, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #e2e8f0;
      border-bottom: 1px solid #1e293b;
      padding-bottom: 12px;
    }
    
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      margin-top: 20px;
    }
    
    .section-title:first-of-type {
      margin-top: 0;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 90px 1fr;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .form-label {
      font-size: 12px;
      color: #94a3b8;
    }
    
    .form-input, .form-select {
      padding: 8px 10px;
      background: #1e293b;
      border: 1px solid #2d3748;
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 13px;
      width: 100%;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .form-input:disabled {
      background: #0a0e1a;
      color: #64748b;
      cursor: not-allowed;
    }
    
    .trend-row {
      display: grid;
      grid-template-columns: 50px 1fr 60px;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      background: #1e293b;
      border-radius: 6px;
    }
    
    .trend-label {
      font-weight: 600;
      font-size: 13px;
    }
    
    .trend-label.daily { color: #60a5fa; }
    .trend-label.hourly { color: #a78bfa; }
    .trend-label.minute { color: #34d399; }
    
    .trend-select {
      padding: 6px 10px;
      background: #0a0e1a;
      border: 1px solid #2d3748;
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 13px;
      width: 100%;
    }
    
    .trend-weight {
      text-align: center;
      font-size: 11px;
      color: #64748b;
      background: #0a0e1a;
      padding: 3px 6px;
      border-radius: 4px;
    }
    
    .gauge-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 20px 0;
      width: 100%;
    }
    
    /* Modern Metric Cards */
    .metric-card {
      background: rgba(15, 20, 25, 0.6);
      border: 1px solid rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    /* Vorteil Card Specific Styles */
    .vorteil-card {
      background: linear-gradient(135deg, rgba(20, 25, 35, 0.95) 0%, rgba(15, 20, 30, 0.95) 100%);
      border: 1px solid rgba(40, 50, 70, 0.5);
      padding: 24px;
    }
    
    .vorteil-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .vorteil-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      letter-spacing: 2px;
    }
    
    .vorteil-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .vorteil-percentage {
      font-size: 48px;
      font-weight: 700;
      color: #e2e8f0;
      line-height: 1;
      transition: all 0.3s ease;
    }
    
    .vorteil-signal {
      display: inline-block;
      padding: 6px 20px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }
    
    .vorteil-signal.short {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    
    .vorteil-signal.neutral {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid #475569;
      color: #94a3b8;
    }
    
    .vorteil-signal.long {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid #10b981;
      color: #10b981;
    }
    
    .vorteil-bar-wrapper {
      position: relative;
    }
    
    .vorteil-bar-container {
      position: relative;
      height: 32px;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      background: rgba(30, 41, 59, 0.3);
    }
    
    .vorteil-bar-segment {
      flex: 1;
      position: relative;
    }
    
    .vorteil-bar-segment.short {
      background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
    }
    
    .vorteil-bar-segment.neutral {
      background: linear-gradient(90deg, #475569 0%, #64748b 100%);
    }
    
    .vorteil-bar-segment.long {
      background: linear-gradient(90deg, #059669 0%, #10b981 100%);
    }
    
    .vorteil-bar-indicator {
      position: absolute;
      top: -4px;
      width: 8px;
      height: 40px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      left: 50%;
      transform: translateX(-50%);
    }
    
    .vorteil-scale {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      padding: 0 4px;
    }
    
    .vorteil-scale span {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.5), transparent);
      transform: translateX(-100%);
      animation: shimmer-line 3s infinite;
    }
    
    @keyframes shimmer-line {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .metric-label {
      font-size: 10px;
      color: #64748b;
      font-weight: 600;
      letter-spacing: 1.2px;
      text-transform: uppercase;
    }
    
    .metric-icon {
      font-size: 20px;
      opacity: 0.8;
    }
    
    .metric-value-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .metric-main-value {
      font-size: 32px;
      font-weight: 800;
      color: #e2e8f0;
      line-height: 1;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .metric-sub-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Vorteil Level Bar */
    .metric-bar-container {
      position: relative;
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .metric-bar-background {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }
    
    .metric-bar-fill {
      position: absolute;
      height: 100%;
      border-radius: 10px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
    }
    
    .metric-scale {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      font-weight: 600;
      margin-top: -8px;
    }
    
    /* Balance Level Circular Progress */
    .metric-circular-progress {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: -10px;
    }
    
    /* Risk Level Indicators */
    .risk-indicator-container {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .risk-indicator {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid rgba(30, 41, 59, 0.5);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    
    .risk-indicator span {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: #64748b;
    }
    
    .risk-indicator.risk-low.active {
      background: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
    }
    
    .risk-indicator.risk-low.active span {
      color: #10b981;
    }
    
    .risk-indicator.risk-medium.active {
      background: rgba(245, 158, 11, 0.2);
      border-color: #f59e0b;
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.3);
    }
    
    .risk-indicator.risk-medium.active span {
      color: #f59e0b;
    }
    
    .risk-indicator.risk-high.active {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
      animation: pulse-risk 2s infinite;
    }
    
    .risk-indicator.risk-high.active span {
      color: #ef4444;
    }
    
    @keyframes pulse-risk {
      0%, 100% { 
        box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
      }
      50% { 
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
      }
    }
    
    .gear-display {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #10b981, #34d399);
      border-radius: 16px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .gear-suggestion {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.9);
      color: #0a0e1a;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .gear-number {
      font-size: 64px;
      font-weight: 900;
      color: white;
      text-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .gear-selector {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }
    
    .gear-btn {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .gear-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .gear-btn.active {
      background: rgba(255,255,255,0.3);
      border-color: white;
    }
    
    .gear-btn.suggested {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .risk-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .risk-btn {
      padding: 10px 6px;
      background: #1e293b;
      border: 2px solid #2d3748;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .risk-btn.active {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
    
    .risk-title {
      font-size: 11px;
      font-weight: 600;
      color: #e2e8f0;
    }
    
    .risk-percent {
      font-size: 14px;
      font-weight: 700;
      color: #10b981;
      margin-top: 2px;
    }
    
    .trade-box {
      background: linear-gradient(135deg, #1e293b, #334155);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid #334155;
    }
    
    .trade-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .trade-item {
      display: flex;
      flex-direction: column;
    }
    
    .trade-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .trade-value {
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
      padding: 6px 10px;
      background: #0a0e1a;
      border-radius: 4px;
      border: 1px solid #2d3748;
    }
    
    .trade-value.profit { color: #10b981; }
    .trade-value.loss { color: #ef4444; }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 8px;
      margin-top: 16px;
    }
    
    .action-button {
      padding: 14px 20px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    
    .action-button.buy {
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
    }
    
    .action-button.sell {
      background: linear-gradient(135deg, #ef4444, #f87171);
      color: white;
    }
    
    .action-button.add {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
    }
    
    .action-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .strategy-suggestions {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .suggestion-title {
      font-size: 11px;
      color: #34d399;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .suggestion-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .suggestion-tag {
      padding: 4px 10px;
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .suggestion-tag:hover {
      background: rgba(16, 185, 129, 0.3);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    
    .stat-box {
      padding: 10px;
      background: #1e293b;
      border-radius: 6px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }
    
    .crv-display {
      text-align: center;
      padding: 12px;
      background: #1e293b;
      border-radius: 6px;
      margin: 12px 0;
    }
    
    .crv-value {
      font-size: 28px;
      font-weight: 900;
    }
    
    .crv-good { color: #10b981; }
    .crv-neutral { color: #f59e0b; }
    .crv-bad { color: #ef4444; }
    
    .save-button {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .save-button:hover {
      background: #2563eb;
    }
    
    .dashboard-card {
      background: #0f1419;
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .dashboard-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }
    
    .table-container {
      background: #0f1419;
      border: 1px solid #1e293b;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #1e293b;
      padding: 10px 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #2d3748;
    }
    
    .data-table td {
      padding: 10px 12px;
      font-size: 13px;
      color: #e2e8f0;
      border-bottom: 1px solid #1e293b;
    }
    
    .data-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }
    
    .edit-btn, .delete-btn {
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      margin-right: 4px;
    }
    
    .edit-btn {
      background: #3b82f6;
      color: white;
    }
    
    .delete-btn {
      background: #ef4444;
      color: white;
    }
    
    .account-card {
      background: rgba(15, 20, 25, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .account-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .account-card:hover {
      border-color: rgba(59, 130, 246, 0.6);
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
    }
    
    .account-card:hover::before {
      left: 100%;
    }
    
    .account-card.main-account {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.05);
    }
    
    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .account-name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .account-type {
      font-size: 11px;
      padding: 2px 8px;
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
      border-radius: 4px;
    }
    
    .account-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .account-stat {
      text-align: center;
    }
    
    .account-stat-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
    }
    
    .account-stat-value {
      font-size: 18px;
      font-weight: 600;
      margin-top: 2px;
    }
    
    .account-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .main-indicator {
      display: inline-block;
      padding: 2px 8px;
      background: #10b981;
      color: white;
      font-size: 10px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 600;
    }
    
    .strategy-card {
      background: rgba(15, 20, 25, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .strategy-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .strategy-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.4);
    }
    
    .strategy-card:hover::after {
      opacity: 1;
    }
    
    .strategy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .strategy-name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .strategy-type {
      font-size: 11px;
      padding: 2px 8px;
      background: rgba(16, 185, 129, 0.1);
      color: #34d399;
      border-radius: 4px;
    }
    
    .strategy-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 12px;
      color: #94a3b8;
    }
    
    .strategy-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .add-button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .add-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .add-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .add-button:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .add-button:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #0f1419;
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #64748b;
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body {
      display: grid;
      gap: 16px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 10px;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(45, 55, 72, 0.5);
      color: #e2e8f0;
      z-index: 1001;
      transform: translateX(400px);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 350px;
      font-size: 13px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .notification.show {
      transform: translateX(0);
      animation: slideInBounce 0.5s ease-out;
    }
    
    @keyframes slideInBounce {
      0% {
        transform: translateX(400px);
      }
      60% {
        transform: translateX(-20px);
      }
      80% {
        transform: translateX(10px);
      }
      100% {
        transform: translateX(0);
      }
    }
    
    .notification.success {
      border-color: rgba(16, 185, 129, 0.5);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border-left: 3px solid #10b981;
    }
    
    .notification.error {
      border-color: rgba(239, 68, 68, 0.5);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      border-left: 3px solid #ef4444;
    }
    
    /* Dashboard Widgets */
    .widget-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .widget {
      background: rgba(15, 20, 25, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .widget:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .widget-title {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .widget-value {
      font-size: 28px;
      font-weight: 700;
      color: #e2e8f0;
      margin-bottom: 8px;
    }
    
    .widget-change {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .widget-change.positive {
      color: #10b981;
    }
    
    .widget-change.negative {
      color: #ef4444;
    }
    
    /* Progress Bars */
    .progress-container {
      margin-top: 12px;
    }
    
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 6px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      border-radius: 10px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Mini Charts */
    .mini-chart {
      height: 60px;
      margin-top: 12px;
      position: relative;
    }
    
    .mini-chart-svg {
      width: 100%;
      height: 100%;
    }
    
    .mini-chart-line {
      stroke: #3b82f6;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .mini-chart-area {
      fill: url(#chart-gradient);
      opacity: 0.3;
    }
    
    .mini-chart-dot {
      fill: #3b82f6;
      stroke: #0f1419;
      stroke-width: 2;
      r: 4;
      transition: r 0.3s;
    }
    
    .mini-chart-dot:hover {
      r: 6;
    }
    
    .entry-exit-point {
      display: grid;
      grid-template-columns: 120px 120px 80px 40px;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    
    .entry-exit-point input {
      padding: 6px 8px;
      background: #1e293b;
      border: 1px solid #2d3748;
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 12px;
    }
    
    .remove-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .screenshot-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #2d3748;
      cursor: pointer;
    }
    
    .screenshot-thumb:hover {
      border-color: #3b82f6;
    }
    
    .main-account-btn {
      padding: 6px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .main-account-btn.inactive {
      background: #64748b;
    }
    /* App Wrapper Base Style */
    .app-wrapper {
      background: linear-gradient(135deg, #0a0e1a 0%, #0f1318 100%);
      min-height: 100vh;
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: 0;
    }
    
    /* ============================================
       RESPONSIVE DESIGN
    ============================================ */
    
    /* Mobile Menu Toggle Button */
    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #e2e8f0;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      margin-right: 12px;
    }
    
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }
    
    .mobile-overlay.active {
      display: block;
    }
    
    /* Tablet View (max-width: 1200px) */
    @media (max-width: 1200px) {
      .container {
        padding: 16px;
      }
      
      .gauge-grid {
        gap: 12px;
      }
      
      .widget-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .accounts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Mobile View (max-width: 768px) */
    @media (max-width: 768px) {
      /* App Container Mobile */
      .app-wrapper {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
        box-shadow: none;
      }
      
      body {
        background: #0a0e1a;
        margin: 0;
        padding: 0;
      }
      
      
      /* Header adjustments - sticky on mobile */
      .header-bar {
        position: sticky !important;
        position: -webkit-sticky !important;
        top: 0 !important;
        z-index: 200;
        padding: 12px 16px;
        flex-wrap: wrap;
        border-radius: 0;
        background: rgba(15, 20, 25, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      
      .header-title {
        flex: 1;
      }
      
      .header-title span {
        font-size: 16px;
      }
      
      .header-actions {
        display: none; /* Hide on mobile for space */
      }
      
      .save-button {
        display: none;
      }
      
      /* Module Container Mobile */
      .module {
        padding: 16px;
      }
      
      .dashboard {
        padding: 16px;
        gap: 16px;
      }
      
      /* Navigation - sticky horizontal scrollable on mobile */
      .tab-bar {
        position: sticky !important;
        position: -webkit-sticky !important;
        top: 60px !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        height: auto !important;
        display: flex !important;
        flex-direction: row !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        background: rgba(15, 20, 25, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 8px !important;
        gap: 8px;
        -webkit-overflow-scrolling: touch;
        border-bottom: 1px solid rgba(30, 41, 59, 0.5);
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      
      .tab {
        flex-shrink: 0;
        padding: 10px 16px !important;
        font-size: 13px;
        white-space: nowrap;
        min-width: auto;
      }
      
      /* Hide mobile menu toggle and overlay on mobile since tabs are visible */
      .mobile-menu-toggle {
        display: none !important;
      }
      
      .mobile-overlay {
        display: none !important;
      }
      
      /* Grid Layouts */
      .gauge-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .widget-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .accounts-grid {
        grid-template-columns: 1fr;
      }
      
      .strategies-grid {
        grid-template-columns: 1fr;
      }
      
      /* Market Analysis Module Mobile Layout */
      #market-module .dashboard {
        display: flex !important;
        flex-direction: column !important;
        gap: 16px;
      }
      
      #market-module .panel {
        width: 100%;
        margin: 0;
      }
      
      /* Module padding on mobile */
      .module {
        padding: 16px !important;
      }
      
      /* Form rows stack on mobile */
      .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .form-label {
        font-weight: 600;
        margin-bottom: 4px;
      }
      
      /* Panel adjustments */
      .panel {
        padding: 16px;
        border-radius: 12px;
      }
      
      /* Metric Cards */
      .metric-card {
        padding: 16px;
      }
      
      .metric-main-value {
        font-size: 28px;
      }
      
      .metric-circular-progress svg {
        width: 60px !important;
        height: 60px !important;
      }
      
      /* Form elements */
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-group {
        width: 100%;
      }
      
      /* Buttons */
      .add-button {
        width: 100%;
        padding: 14px;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 8px;
      }
      
      .action-buttons button {
        width: 100%;
      }
      
      /* Tables */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      table {
        min-width: 500px;
      }
      
      /* Modal adjustments */
      .modal-content {
        width: 95%;
        padding: 20px;
        margin: 20px auto;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      /* Header balance */
      .balance {
        font-size: 14px;
      }
      
      /* Risk indicators */
      .risk-indicator {
        padding: 6px;
      }
      
      .risk-indicator span {
        font-size: 9px;
      }
    }
    
    /* Small Mobile View (max-width: 480px) */
    @media (max-width: 480px) {
      /* Full width on very small screens */
      .app-wrapper {
        border-radius: 0;
      }
      
      /* Compact header */
      .header-bar {
        padding: 10px 12px;
      }
      
      .logo {
        width: 28px;
        height: 28px;
        font-size: 16px;
      }
      
      .header-title span {
        font-size: 14px;
        font-weight: 600;
      }
      
      /* Smaller paddings */
      .module {
        padding: 12px;
      }
      
      .dashboard {
        padding: 12px;
        gap: 12px;
      }
      
      .panel {
        padding: 14px;
      }
      
      /* Metric Cards */
      .metric-main-value {
        font-size: 24px;
      }
      
      .metric-label {
        font-size: 9px;
      }
      
      .metric-icon {
        font-size: 16px;
      }
      
      /* Widget values */
      .widget-value {
        font-size: 20px;
      }
      
      /* Account cards */
      .account-card {
        padding: 12px;
      }
      
      .account-name {
        font-size: 14px;
      }
      
      .account-balance {
        font-size: 18px;
      }
      
      /* Strategy cards */
      .strategy-card {
        padding: 12px;
      }
      
      /* Notifications */
      .notification {
        right: 10px;
        left: 10px;
        width: auto;
        max-width: none;
      }
      
      /* Form controls - prevent zoom on iOS */
      select, 
      input[type="text"], 
      input[type="number"], 
      input[type="password"], 
      textarea {
        font-size: 16px;
      }
      
      /* Gear display */
      .gear-display {
        font-size: 80px;
      }
      
      /* Tab content */
      .tab-content {
        padding: 12px;
      }
    }
    
    /* Desktop optimizations */
    @media (min-width: 1200px) {
      /* Full width utilization */
      .app-wrapper {
        padding: 0 20px;
      }
      
      .module {
        padding: 30px;
        max-width: 100%;
      }
      
      .dashboard {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
        padding: 0;
      }
      
      /* Better spacing for panels */
      .panel {
        padding: 24px;
      }
      
      /* Better proportions for metric cards */
      .metric-card {
        min-height: 180px;
      }
      
      /* Tab bar stays horizontal */
      .tab-bar {
        position: relative !important;
        display: flex !important;
        flex-direction: row !important;
        width: 100% !important;
        overflow-x: visible !important;
      }
      
      /* Ensure gauge-grid shows all 3 cards */
      .gauge-grid {
        grid-template-columns: repeat(3, 1fr) !important;
      }
    }
    
    /* Large Desktop View (min-width: 1600px) */
    @media (min-width: 1600px) {
      .app-wrapper {
        padding: 0 40px;
      }
      
      .module {
        max-width: 1920px;
        margin: 0 auto;
        padding: 40px;
      }
      
      .dashboard {
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
      }
      
      .panel {
        padding: 28px;
      }
      
      .gauge-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
      }
      
      .widget-container {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .accounts-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* Ultra-wide screens */
    @media (min-width: 2000px) {
      .app-wrapper {
        max-width: 95%;
        width: 95%;
        margin: 20px auto;
      }
      
      body {
        padding: 0 2.5%;
      }
      
      .module {
        max-width: 100%;
        padding: 50px 80px;
      }
      
      .dashboard {
        grid-template-columns: repeat(3, minmax(500px, 1fr));
        gap: 40px;
      }
      
      .panel {
        padding: 32px;
      }
      
      .gauge-grid {
        grid-template-columns: repeat(3, minmax(400px, 1fr));
        gap: 40px;
      }
      
      .metric-card {
        padding: 28px;
        min-height: 200px;
      }
      
      .widget-container {
        grid-template-columns: repeat(4, minmax(280px, 1fr));
        gap: 28px;
      }
      
      /* Größere Schrift für bessere Lesbarkeit auf großen Bildschirmen */
      .panel-title {
        font-size: 20px;
      }
      
      .metric-main-value {
        font-size: 42px;
      }
      
      .widget-value {
        font-size: 28px;
      }
    }
    
    /* Touch Device Optimizations */
    @media (hover: none) and (pointer: coarse) {
      /* Increase touch targets */
      .nav-tab, 
      .add-button, 
      button {
        min-height: 44px;
      }
      
      .account-card, 
      .strategy-card {
        min-height: 60px;
      }
      
      /* Remove hover effects on touch */
      .panel:hover,
      .account-card:hover,
      .strategy-card:hover,
      .metric-card:hover,
      .widget:hover {
        transform: none;
        box-shadow: none;
      }
      
      /* Improve touch scrolling */
      * {
        -webkit-tap-highlight-color: transparent;
      }
      
      .scrollable {
        -webkit-overflow-scrolling: touch;
      }
    }
    
    /* Landscape Mobile */
    @media (max-width: 812px) and (orientation: landscape) {
      .nav-tabs {
        top: 50px;
        height: calc(100vh - 50px);
      }
      
      .header {
        padding: 8px 16px;
      }
      
      .gauge-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .widget-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Print Styles */
    @media print {
      .header, 
      .nav-tabs, 
      .add-button, 
      .action-buttons,
      .mobile-menu-toggle {
        display: none !important;
      }
      
      body {
        background: white;
        color: black;
      }
      
      .panel {
        border: 1px solid #ccc;
        box-shadow: none;
        background: white;
      }
      
      .metric-card,
      .widget,
      .account-card,
      .strategy-card {
        background: white;
        border: 1px solid #ccc;
        color: black;
      }
    }
    
    /* Accessibility - Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
  <!-- Transaction Modal -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="transaction-modal-title">Transaktion</h2>
        <button class="modal-close" onclick="closeModal('transaction-modal')">×</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label class="form-label">Account</label>
          <select class="form-select" id="transaction-account">
            <!-- Will be populated with accounts -->
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Typ</label>
          <select class="form-select" id="transaction-type">
            <option value="deposit">Einzahlung</option>
            <option value="withdrawal">Auszahlung</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Betrag</label>
          <input type="number" class="form-input" id="transaction-amount" placeholder="0.00" step="0.01" min="0" />
        </div>
        <div class="form-row">
          <label class="form-label">Beschreibung</label>
          <textarea class="form-input" id="transaction-description" rows="3" 
                    placeholder="z.B. Gewinnentnahme, Kapitalerhöhung, Steuern"></textarea>
        </div>
        <div style="background: #1e293b; border-radius: 6px; padding: 12px; margin-top: 16px;">
          <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Account-Info</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
            <div>Aktuelle Balance: <span id="transaction-current-balance" style="font-weight: 600;">€0</span></div>
            <div>Nach Transaktion: <span id="transaction-new-balance" style="font-weight: 600;">€0</span></div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="save-button" onclick="executeTransaction()">Ausführen</button>
        <button class="btn btn-secondary" onclick="closeModal('transaction-modal')">Abbrechen</button>
      </div>
    </div>
  </div>
  
  <script>
// ABSOLUT ERSTE PRIORITÄT: Strategie-Funktionen global definieren
window.editStrategy = function(id) {
  console.log('editStrategy GLOBAL aufgerufen mit ID:', id);
  alert('Edit Strategie ID: ' + id + ' wurde aufgerufen!');
  // Weitere Logik kommt später
};

window.deleteStrategy = function(id) {
  console.log('deleteStrategy GLOBAL aufgerufen mit ID:', id);
  if (confirm('Strategie mit ID ' + id + ' wirklich löschen?')) {
    alert('Strategie ' + id + ' wurde gelöscht!');
    // Weitere Logik kommt später
  }
};

// Global Variables
let accounts = [];
let strategies = [];
let trades = [];
let transactions = []; // New: for deposits and withdrawals
let currentGear = 3;
let currentRisk = 1.0;
let currentAdvantage = 0;
let mainAccount = null;
let editingAccountId = null;
let editingStrategyId = null;
let currentTradeId = null;
let nextTradeId = 1;
let entryPointCount = 0;
let exitPointCount = 0;
let tradeScreenshots = [];

// Überschreibe die Funktionen mit vollständiger Implementierung
window.editStrategy = function(id) {
  console.log('editStrategy aufgerufen mit ID:', id);
  editingStrategyId = id;
  const strategy = strategies.find(s => s.id === id);
  
  if (!strategy) {
    console.error('Strategie nicht gefunden mit ID:', id);
    showNotification('Strategie nicht gefunden', 'error');
    return;
  }
  
  // Fülle Modal mit vorhandenen Daten
  document.getElementById('strategy-modal-title').textContent = 'Strategie bearbeiten';
  document.getElementById('strategy-name').value = strategy.name;
  document.getElementById('strategy-type').value = strategy.type;
  document.getElementById('strategy-description').value = strategy.description || '';
  document.getElementById('strategy-entry').value = strategy.entry || '';
  document.getElementById('strategy-exit').value = strategy.exit || '';
  document.getElementById('strategy-management').value = strategy.management || '';
  
  // Handle both old single value and new range format
  if (strategy.aggressivenessMin !== undefined && strategy.aggressivenessMax !== undefined) {
    document.getElementById('strategy-aggressiveness-min').value = strategy.aggressivenessMin;
    document.getElementById('strategy-aggressiveness-max').value = strategy.aggressivenessMax;
  } else {
    const singleValue = strategy.aggressiveness || 50;
    document.getElementById('strategy-aggressiveness-min').value = Math.max(0, singleValue - 25);
    document.getElementById('strategy-aggressiveness-max').value = Math.min(100, singleValue + 25);
  }
  
  if (typeof updateAggressivenessDisplay === 'function') {
    updateAggressivenessDisplay();
  }
  
  // Setze Kontozonen
  if (strategy.zones) {
    document.getElementById('zone-green').checked = strategy.zones.green || false;
    document.getElementById('zone-orange').checked = strategy.zones.orange || false;
    document.getElementById('zone-red').checked = strategy.zones.red || false;
  } else {
    document.getElementById('zone-green').checked = true;
    document.getElementById('zone-orange').checked = false;
    document.getElementById('zone-red').checked = false;
  }
  
  document.getElementById('strategy-long-min').value = strategy.longMinAdvantage || '';
  document.getElementById('strategy-long-max').value = strategy.longMaxAdvantage || '';
  document.getElementById('strategy-short-min').value = strategy.shortMinAdvantage || '';
  document.getElementById('strategy-short-max').value = strategy.shortMaxAdvantage || '';
  document.getElementById('strategy-rrr').value = strategy.rrr || '';
  
  document.getElementById('strategy-modal').classList.add('active');
};

window.deleteStrategy = function(id) {
  console.log('deleteStrategy aufgerufen mit ID:', id);
  if (confirm('Strategie wirklich löschen?')) {
    strategies = strategies.filter(s => s.id !== id);
    if (typeof saveData === 'function') saveData();
    if (typeof renderStrategies === 'function') renderStrategies();
    if (typeof updateStrategySelect === 'function') updateStrategySelect();
    if (typeof suggestStrategies === 'function') suggestStrategies();
    if (typeof showNotification === 'function') showNotification('Strategie gelöscht', 'success');
  }
};

// Initialize Trade ID system
function initializeTradeId() {
  let maxId = 0;
  trades.forEach(trade => {
    const id = parseInt(trade.id);
    if (!isNaN(id) && id > maxId) {
      maxId = id;
    }
  });
  nextTradeId = maxId + 1;
}

// Get next Trade ID
function getNextTradeId() {
  return nextTradeId++;
}

// Data Storage Functions
function loadData() {
  accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
  strategies = JSON.parse(localStorage.getItem('strategies') || '[]');
  trades = JSON.parse(localStorage.getItem('trades') || '[]');
  transactions = JSON.parse(localStorage.getItem('transactions') || '[]'); // Load transactions
  
  if (accounts.length === 0) {
    accounts = [{
      id: 1,
      name: 'Papertrading',
      accountNumber: 'DEMO-001',
      type: 'Paper',
      currency: 'EUR',
      initialBalance: 10000,
      currentBalance: 10000,
      isMain: true
    }];
    saveData();
  }
  
  if (strategies.length === 0) {
    strategies = [
      {
        id: 1, 
        name: 'SQ Long/Short', 
        type: 'Sequenz', 
        longMinAdvantage: 33, 
        longMaxAdvantage: 100, 
        shortMinAdvantage: -100, 
        shortMaxAdvantage: -33, 
        rrr: '1.5 - 3.0'
      },
      {
        id: 2, 
        name: 'BOR Anticipated', 
        type: 'Breakout', 
        longMinAdvantage: 50, 
        longMaxAdvantage: 100, 
        shortMinAdvantage: -100, 
        shortMaxAdvantage: -50, 
        rrr: '2.0 - 4.0'
      },
      {
        id: 3, 
        name: 'Gap Close', 
        type: 'Gap', 
        longMinAdvantage: -20, 
        longMaxAdvantage: 100, 
        shortMinAdvantage: -100, 
        shortMaxAdvantage: 20, 
        rrr: '1.0 - 2.0'
      },
      {
        id: 4, 
        name: 'News Trading', 
        type: 'News', 
        longMinAdvantage: 20, 
        longMaxAdvantage: 100, 
        shortMinAdvantage: -100, 
        shortMaxAdvantage: -20, 
        rrr: '1.5 - 3.0'
      }
    ];
    saveData();
  }
  
  mainAccount = accounts.find(a => a.isMain) || accounts[0];
  if (mainAccount && !mainAccount.isMain) {
    mainAccount.isMain = true;
    saveData();
  }
}

function saveData() {
  localStorage.setItem('accounts', JSON.stringify(accounts));
  localStorage.setItem('strategies', JSON.stringify(strategies));
  localStorage.setItem('trades', JSON.stringify(trades));
  localStorage.setItem('transactions', JSON.stringify(transactions)); // Save transactions
}

// Notification System
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.classList.add('show'), 10);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => document.body.removeChild(notification), 300);
  }, 3000);
}

// Module Switching
function switchModule(moduleName, event) {
  document.querySelectorAll('.module').forEach(m => {
    m.classList.remove('active');
  });
  
  document.getElementById(moduleName + '-module').classList.add('active');
  
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('active');
  });
  event.target.classList.add('active');
  
  if (moduleName === 'reports') {
    updateReports();
  }
}

// Calculations
function calculateAll() {
  calculateAdvantage();
  calculateBalanceLevel();
  calculateRiskLevel();
  suggestGear();
  suggestStrategies();
  calculatePosition();
}

function calculateAdvantage() {
  const daily = parseFloat(document.getElementById('trend-daily').value) * 0.2;
  const hourly = parseFloat(document.getElementById('trend-hourly').value) * 0.7;
  const minute = parseFloat(document.getElementById('trend-minute').value) * 0.1;
  
  currentAdvantage = Math.round((daily + hourly + minute) * 100);
  
  const normalizedValue = Math.max(-100, Math.min(100, currentAdvantage));
  
  // Update elegant Vorteil display
  const benefitValue = document.getElementById('benefit-value');
  const benefitSignal = document.getElementById('benefit-signal');
  const benefitLabel = document.getElementById('benefit-label');
  const benefitIndicator = document.getElementById('benefit-indicator');
  
  // Update percentage display with sign
  if (benefitValue) {
    const sign = currentAdvantage > 0 ? '+' : currentAdvantage < 0 ? '-' : '';
    benefitValue.textContent = sign + Math.abs(currentAdvantage) + '%';
    
    // Update text color based on value
    if (currentAdvantage >= 33) {
      benefitValue.style.color = '#10b981';
    } else if (currentAdvantage <= -33) {
      benefitValue.style.color = '#ef4444';
    } else {
      benefitValue.style.color = '#e2e8f0';
    }
  }
  
  // Update signal badge
  if (benefitSignal && benefitLabel) {
    // Remove all classes first
    benefitSignal.className = 'vorteil-signal';
    
    if (currentAdvantage >= 33) {
      benefitSignal.classList.add('long');
      benefitLabel.textContent = 'LONG';
    } else if (currentAdvantage <= -33) {
      benefitSignal.classList.add('short');
      benefitLabel.textContent = 'SHORT';
    } else {
      benefitSignal.classList.add('neutral');
      benefitLabel.textContent = 'NEUTRAL';
    }
  }
  
  // Update indicator position on bar
  if (benefitIndicator) {
    // Calculate position (0-100%)
    const position = ((normalizedValue + 100) / 200) * 100;
    benefitIndicator.style.left = position + '%';
  }
  
  // Debug: Log current advantage
  console.log('Current Advantage:', currentAdvantage);
}

function calculateBalanceLevel() {
  if (!mainAccount) return;
  
  updateAllAccountBalances();
  
  const performance = ((mainAccount.currentBalance - mainAccount.initialBalance) / mainAccount.initialBalance * 100).toFixed(1);
  const balanceLevel = 100 + parseFloat(performance);
  const normalizedBalance = Math.max(0, Math.min(200, balanceLevel));
  const displayBalance = normalizedBalance / 2;
  const rotation = -90 + (displayBalance * 1.8);
  
  // Update circular progress
  const marketCircle = document.getElementById('market-circle');
  const marketLabel = document.getElementById('market-label');
  
  if (marketCircle) {
    const circumference = 283; // 2 * PI * 45
    const offset = circumference - (normalizedBalance / 200) * circumference;
    marketCircle.style.strokeDashoffset = offset;
    
    // Update color based on performance
    if (parseFloat(performance) > 10) {
      marketCircle.style.stroke = '#10b981';
      if (marketLabel) {
        marketLabel.textContent = 'Profit';
        marketLabel.style.color = '#10b981';
      }
    } else if (parseFloat(performance) < -10) {
      marketCircle.style.stroke = '#ef4444';
      if (marketLabel) {
        marketLabel.textContent = 'Loss';
        marketLabel.style.color = '#ef4444';
      }
    } else {
      marketCircle.style.stroke = '#f59e0b';
      if (marketLabel) {
        marketLabel.textContent = 'Baseline';
        marketLabel.style.color = '#f59e0b';
      }
    }
  }
  
  document.getElementById('market-value').textContent = Math.round(balanceLevel) + '%';
  
  const headerBalance = document.getElementById('header-balance');
  const currencySymbol = mainAccount.currency || 'EUR';
  headerBalance.textContent = `${currencySymbol} ${mainAccount.currentBalance.toLocaleString('de-DE')} (${performance >= 0 ? '+' : ''}${performance}%)`;
  headerBalance.className = performance > 0 ? 'balance profit' : performance < 0 ? 'balance loss' : 'balance neutral';
}

function calculateRiskLevel() {
  let riskScore = 50;
  
  if (Math.abs(currentAdvantage) >= 50) {
    riskScore += 30;
  } else if (Math.abs(currentAdvantage) >= 33) {
    riskScore += 20;
  }
  
  if (mainAccount) {
    const performance = (mainAccount.currentBalance - mainAccount.initialBalance) / mainAccount.initialBalance;
    if (performance > 0.1) {
      riskScore += 20;
    } else if (performance < -0.1) {
      riskScore -= 30;
    }
  }
  
  riskScore = Math.max(0, Math.min(150, riskScore));
  
  const displayRisk = Math.min(100, riskScore);
  const rotation = -90 + (displayRisk * 1.8);
  
  // Update Risk Indicators
  const riskLow = document.getElementById('risk-low');
  const riskMedium = document.getElementById('risk-medium');
  const riskHigh = document.getElementById('risk-high');
  const riskLabel = document.getElementById('risk-label');
  
  // Remove all active classes
  if (riskLow) riskLow.classList.remove('active');
  if (riskMedium) riskMedium.classList.remove('active');
  if (riskHigh) riskHigh.classList.remove('active');
  
  // Set active based on risk score
  if (riskScore <= 33) {
    if (riskLow) riskLow.classList.add('active');
    if (riskLabel) {
      riskLabel.textContent = 'Niedrig';
      riskLabel.style.color = '#10b981';
    }
  } else if (riskScore <= 66) {
    if (riskMedium) riskMedium.classList.add('active');
    if (riskLabel) {
      riskLabel.textContent = 'Moderat';
      riskLabel.style.color = '#f59e0b';
    }
  } else {
    if (riskHigh) riskHigh.classList.add('active');
    if (riskLabel) {
      riskLabel.textContent = 'Hoch';
      riskLabel.style.color = '#ef4444';
    }
  }
  
  document.getElementById('risk-level-value').textContent = Math.round(riskScore) + '%';
  
  return riskScore;
}

function calculatePosition() {
  const entry = parseFloat(document.getElementById('entry-price').value) || 0;
  const stop = parseFloat(document.getElementById('stop-price').value) || 0;
  const target = parseFloat(document.getElementById('target-price').value) || 0;
  
  // Get selected account instead of only using mainAccount
  const accountId = parseInt(document.getElementById('account-select').value);
  const selectedAccount = accounts.find(a => a.id === accountId) || mainAccount;
  
  if (!entry || !stop || !target || !selectedAccount) return;
  
  const marketType = document.getElementById('market-select').value;
  const isStock = marketType.startsWith('stocks-');
  
  const instrumentValue = document.getElementById('instrument-select').value;
  const [tickValue, tickSize] = instrumentValue ? instrumentValue.split(',').map(parseFloat) : [5, 1];
  
  const riskAmount = selectedAccount.currentBalance * (currentRisk / 100);
  
  let positionSize, actualRiskEuros, actualRewardEuros;
  
  if (isStock) {
    // Für Aktien: Direkte Preisberechnung
    const riskPerShare = Math.abs(entry - stop);
    const rewardPerShare = Math.abs(target - entry);
    const rrr = riskPerShare > 0 ? (rewardPerShare / riskPerShare).toFixed(2) : 0;
    
    positionSize = riskPerShare > 0 ? Math.floor(riskAmount / riskPerShare) : 1;
    actualRiskEuros = riskPerShare * positionSize;
    actualRewardEuros = rewardPerShare * positionSize;
    
    document.getElementById('rrr-value').textContent = rrr;
    document.getElementById('crv-display').textContent = `CRV: ${rrr}`;
    
    const crvDisplay = document.getElementById('crv-display');
    crvDisplay.className = rrr >= 2 ? 'crv-value crv-good' : rrr >= 1 ? 'crv-value crv-neutral' : 'crv-value crv-bad';
  } else {
    // Für Futures/Forex: Tick-basierte Berechnung
    const riskTicks = Math.abs(entry - stop) / tickSize;
    const rewardTicks = Math.abs(target - entry) / tickSize;
    const rrr = riskTicks > 0 ? (rewardTicks / riskTicks).toFixed(2) : 0;
    
    const riskPerContract = riskTicks * tickValue;
    positionSize = riskPerContract > 0 ? Math.floor(riskAmount / riskPerContract) : 1;
    actualRiskEuros = riskPerContract * positionSize;
    actualRewardEuros = rewardTicks * tickValue * positionSize;
    
    document.getElementById('rrr-value').textContent = rrr;
    document.getElementById('crv-display').textContent = `CRV: ${rrr}`;
    
    const crvDisplay = document.getElementById('crv-display');
    crvDisplay.className = rrr >= 2 ? 'crv-value crv-good' : rrr >= 1 ? 'crv-value crv-neutral' : 'crv-value crv-bad';
  }
  
  document.getElementById('risk-euros').textContent = actualRiskEuros.toFixed(0);
  document.getElementById('reward-euros').textContent = actualRewardEuros.toFixed(0);
  document.getElementById('position-size').textContent = positionSize;
  
  // Korrekte Richtungserkennung
  // LONG: Stop Loss unter Entry, Target über Entry
  // SHORT: Stop Loss über Entry, Target unter Entry
  const actionBtn = document.getElementById('action-btn');
  const actionText = document.getElementById('action-text');
  
  if (stop < entry && target > entry) {
    // LONG Trade
    actionText.textContent = 'BUY';
    actionBtn.className = 'action-button buy';
  } else if (stop > entry && target < entry) {
    // SHORT Trade
    actionText.textContent = 'SELL';
    actionBtn.className = 'action-button sell';
  } else {
    // Invalid setup
    actionText.textContent = 'INVALID';
    actionBtn.className = 'action-button buy';
  }
}

function updateAllAccountBalances() {
  accounts.forEach(account => {
    // Calculate P&L from closed trades
    const accountTrades = trades.filter(t => t.accountId === account.id && t.status === 'Closed');
    let totalPL = 0;
    accountTrades.forEach(t => {
      totalPL += parseFloat(t.pl || 0);
    });
    
    // Calculate transactions (deposits and withdrawals)
    const accountTransactions = transactions.filter(t => t.accountId === account.id);
    let totalTransactions = 0;
    accountTransactions.forEach(t => {
      if (t.type === 'deposit') {
        totalTransactions += parseFloat(t.amount || 0);
      } else if (t.type === 'withdrawal') {
        totalTransactions -= parseFloat(t.amount || 0);
      }
    });
    
    // Update balance: initial + P&L + deposits - withdrawals
    account.currentBalance = account.initialBalance + totalPL + totalTransactions;
  });
  saveData();
}

// Transaction Functions
function processTransaction(accountId, amount, type, description = '') {
  const account = accounts.find(a => a.id === accountId);
  if (!account) {
    showNotification('Account nicht gefunden', 'error');
    return false;
  }
  
  // Check if withdrawal is possible
  if (type === 'withdrawal' && amount > account.currentBalance) {
    showNotification('Unzureichende Mittel für Auszahlung', 'error');
    return false;
  }
  
  const transaction = {
    id: Date.now(),
    accountId: accountId,
    accountName: account.name,
    type: type, // 'deposit' or 'withdrawal'
    amount: amount,
    currency: account.currency || 'EUR',
    description: description,
    date: new Date().toLocaleString('de-DE'),
    balanceBefore: account.currentBalance,
    balanceAfter: type === 'deposit' ? 
      account.currentBalance + amount : 
      account.currentBalance - amount
  };
  
  transactions.push(transaction);
  updateAllAccountBalances();
  saveData();
  
  showNotification(
    type === 'deposit' ? 
      `Einzahlung von ${account.currency} ${amount} erfolgreich` : 
      `Auszahlung von ${account.currency} ${amount} erfolgreich`,
    'success'
  );
  
  return true;
}

function getTransactionHistory(accountId = null) {
  if (accountId) {
    return transactions.filter(t => t.accountId === accountId);
  }
  return transactions;
}

function deleteTransaction(transactionId) {
  const index = transactions.findIndex(t => t.id === transactionId);
  if (index !== -1) {
    transactions.splice(index, 1);
    updateAllAccountBalances();
    saveData();
    showNotification('Transaktion gelöscht', 'success');
    return true;
  }
  return false;
}

// UI Update Functions
function updateDashboard() {
  const container = document.getElementById('dashboard-analyses');
  const recentAnalyses = JSON.parse(localStorage.getItem('recentAnalyses') || '[]');
  
  // Add dashboard widgets
  const closedTrades = trades.filter(t => t.status === 'Closed');
  const winningTrades = closedTrades.filter(t => t.pl > 0);
  const totalPL = closedTrades.reduce((sum, t) => sum + t.pl, 0);
  const winRate = closedTrades.length > 0 ? (winningTrades.length / closedTrades.length * 100) : 0;
  const todayTrades = closedTrades.filter(t => {
    const tradeDate = new Date(t.date);
    const today = new Date();
    return tradeDate.toDateString() === today.toDateString();
  });
  const todayPL = todayTrades.reduce((sum, t) => sum + t.pl, 0);
  
  // Calculate monthly goal progress
  const monthlyGoal = 1000; // Example monthly goal
  const currentMonthPL = closedTrades.filter(t => {
    const tradeDate = new Date(t.date);
    const now = new Date();
    return tradeDate.getMonth() === now.getMonth() && tradeDate.getFullYear() === now.getFullYear();
  }).reduce((sum, t) => sum + t.pl, 0);
  const goalProgress = Math.min(100, Math.max(0, (currentMonthPL / monthlyGoal) * 100));
  
  // Create widgets HTML
  const widgetsHTML = `
    <div class="widget-container">
      <!-- Total P&L Widget -->
      <div class="widget">
        <div class="widget-header">
          <span class="widget-title">Total P&L</span>
          <span style="font-size: 20px;">${totalPL >= 0 ? '📈' : '📉'}</span>
        </div>
        <div class="widget-value" style="color: ${totalPL >= 0 ? '#10b981' : '#ef4444'};">
          €${totalPL.toFixed(2)}
        </div>
        <div class="widget-change ${totalPL >= 0 ? 'positive' : 'negative'}">
          ${totalPL >= 0 ? '↑' : '↓'} ${Math.abs(totalPL).toFixed(2)} vom Start
        </div>
      </div>
      
      <!-- Win Rate Widget -->
      <div class="widget">
        <div class="widget-header">
          <span class="widget-title">Win Rate</span>
          <span style="font-size: 20px;">🎯</span>
        </div>
        <div class="widget-value" style="color: ${winRate >= 50 ? '#10b981' : '#ef4444'};">
          ${winRate.toFixed(1)}%
        </div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${winRate}%;"></div>
          </div>
        </div>
      </div>
      
      <!-- Today's Performance -->
      <div class="widget">
        <div class="widget-header">
          <span class="widget-title">Heute</span>
          <span style="font-size: 20px;">📊</span>
        </div>
        <div class="widget-value" style="color: ${todayPL >= 0 ? '#10b981' : '#ef4444'};">
          €${todayPL.toFixed(2)}
        </div>
        <div class="widget-change">
          ${todayTrades.length} Trade${todayTrades.length !== 1 ? 's' : ''} heute
        </div>
      </div>
      
      <!-- Monthly Goal Progress -->
      <div class="widget">
        <div class="widget-header">
          <span class="widget-title">Monatsziel</span>
          <span style="font-size: 20px;">🎯</span>
        </div>
        <div class="widget-value">
          ${goalProgress.toFixed(0)}%
        </div>
        <div class="progress-container">
          <div class="progress-label">
            <span>€${currentMonthPL.toFixed(0)}</span>
            <span>€${monthlyGoal}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${goalProgress}%; background: ${goalProgress >= 100 ? 'linear-gradient(90deg, #10b981, #34d399)' : 'linear-gradient(90deg, #3b82f6, #8b5cf6)'};"></div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  if (recentAnalyses.length === 0) {
    container.innerHTML = widgetsHTML + `
      <div style="text-align: center; padding: 40px; color: #64748b; margin-top: 20px;">
        <h3>Willkommen bei TraceVizion Pro</h3>
        <p>Noch keine Analysen vorhanden. Starte mit der Marktanalyse!</p>
      </div>
    `;
  } else {
    container.innerHTML = recentAnalyses.slice(-5).reverse().map(analysis => {
      const advantageColor = analysis.advantage >= 33 ? '#10b981' : 
                             analysis.advantage <= -33 ? '#ef4444' : '#f59e0b';
      const signal = analysis.advantage >= 33 ? 'LONG' : 
                    analysis.advantage <= -33 ? 'SHORT' : 'NEUTRAL';
      
      return `
        <div style="background: rgba(15, 20, 25, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(30, 41, 59, 0.4); border-radius: 12px; padding: 20px; margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">${analysis.instrument}</h3>
              <div style="font-size: 13px; color: #64748b;">${analysis.date}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 36px; font-weight: 700; color: ${advantageColor};">
                ${analysis.advantage > 0 ? '+' : ''}${analysis.advantage}%
              </div>
              <div style="padding: 4px 12px; background: ${advantageColor}22; color: ${advantageColor}; 
                          border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block;">
                ${signal}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
}

function updateMAInstruments() {
  const market = document.getElementById('ma-market-select').value;
  const instrumentSelect = document.getElementById('ma-instrument-select');
  
  // Complete instrument data for all markets
  const instruments = {
    'dax': [
      {name: 'FDAX', value: '12.5,0.5'},
      {name: 'FDXM', value: '5,1'},
      {name: 'FDXS', value: '1,1'}
    ],
    'sp500': [
      {name: 'ES', value: '12.5,0.25'},
      {name: 'MES', value: '1.25,0.25'}
    ],
    'nasdaq': [
      {name: 'NQ', value: '5,0.25'},
      {name: 'MNQ', value: '0.5,0.25'}
    ],
    'dow': [
      {name: 'YM', value: '5,1'},
      {name: 'MYM', value: '0.5,1'}
    ],
    'russell': [
      {name: 'RTY', value: '5,0.1'},
      {name: 'M2K', value: '0.5,0.1'}
    ],
    'eurostoxx': [
      {name: 'FESX', value: '10,1'},
      {name: 'FESM', value: '5,1'},
      {name: 'FEXM', value: '1,1'}
    ],
    'forex': [
      {name: '6E (EUR/USD)', value: '12.5,0.0001'},
      {name: 'M6E (Micro EUR)', value: '1.25,0.0001'},
      {name: '6B (GBP/USD)', value: '6.25,0.0001'},
      {name: 'M6B (Micro GBP)', value: '0.625,0.0001'},
      {name: '6J (USD/JPY)', value: '12.5,0.000001'},
      {name: 'MJY (Micro JPY)', value: '1.25,0.000001'},
      {name: '6A (AUD/USD)', value: '10,0.0001'},
      {name: '6C (CAD/USD)', value: '10,0.0001'},
      {name: '6S (CHF/USD)', value: '12.5,0.0001'}
    ],
    'commodities': [
      {name: 'GC (Gold)', value: '10,0.1'},
      {name: 'MGC (Micro Gold)', value: '1,0.1'},
      {name: 'SI (Silver)', value: '5,0.01'},
      {name: 'SIL (Micro Silver)', value: '0.5,0.01'},
      {name: 'CL (Crude Oil)', value: '10,0.01'},
      {name: 'MCL (Micro Oil)', value: '1,0.01'},
      {name: 'NG (Natural Gas)', value: '10,0.001'},
      {name: 'HG (Copper)', value: '12.5,0.0005'}
    ],
    'bonds': [
      {name: 'FGBL (Bund)', value: '10,0.01'},
      {name: 'FGBM (Bobl)', value: '10,0.01'},
      {name: 'FGBS (Schatz)', value: '10,0.01'},
      {name: 'ZB (30Y T-Bond)', value: '31.25,0.03125'},
      {name: 'ZN (10Y T-Note)', value: '15.625,0.015625'},
      {name: 'ZF (5Y T-Note)', value: '7.8125,0.0078125'},
      {name: 'ZT (2Y T-Note)', value: '7.8125,0.00390625'}
    ],
    'stocks-dax': [
      {name: 'StockXXX', value: '1,0.01'},
      {name: 'Adidas', value: '1,0.01'},
      {name: 'Airbus', value: '1,0.01'},
      {name: 'Allianz', value: '1,0.01'},
      {name: 'BASF', value: '1,0.01'},
      {name: 'Bayer', value: '1,0.01'},
      {name: 'BMW', value: '1,0.01'},
      {name: 'Continental', value: '1,0.01'},
      {name: 'Deutsche Bank', value: '1,0.01'},
      {name: 'Deutsche Post', value: '1,0.01'},
      {name: 'Deutsche Telekom', value: '1,0.01'},
      {name: 'E.ON', value: '1,0.01'},
      {name: 'Fresenius', value: '1,0.01'},
      {name: 'Infineon', value: '1,0.01'},
      {name: 'Mercedes-Benz', value: '1,0.01'},
      {name: 'Munich Re', value: '1,0.01'},
      {name: 'Porsche AG', value: '1,0.01'},
      {name: 'SAP', value: '1,0.01'},
      {name: 'Siemens', value: '1,0.01'},
      {name: 'Volkswagen', value: '1,0.01'},
      {name: 'Vonovia', value: '1,0.01'}
    ],
    'stocks-sp500': [
      {name: 'StockXXX', value: '1,0.01'},
      {name: 'Apple (AAPL)', value: '1,0.01'},
      {name: 'Microsoft (MSFT)', value: '1,0.01'},
      {name: 'Amazon (AMZN)', value: '1,0.01'},
      {name: 'NVIDIA (NVDA)', value: '1,0.01'},
      {name: 'Alphabet A (GOOGL)', value: '1,0.01'},
      {name: 'Meta (META)', value: '1,0.01'},
      {name: 'Tesla (TSLA)', value: '1,0.01'},
      {name: 'Berkshire B (BRK.B)', value: '1,0.01'},
      {name: 'JPMorgan (JPM)', value: '1,0.01'},
      {name: 'UnitedHealth (UNH)', value: '1,0.01'},
      {name: 'Visa (V)', value: '1,0.01'},
      {name: 'Johnson&Johnson (JNJ)', value: '1,0.01'},
      {name: 'Walmart (WMT)', value: '1,0.01'},
      {name: 'Procter&Gamble (PG)', value: '1,0.01'},
      {name: 'Mastercard (MA)', value: '1,0.01'},
      {name: 'Home Depot (HD)', value: '1,0.01'},
      {name: 'Chevron (CVX)', value: '1,0.01'},
      {name: 'Coca-Cola (KO)', value: '1,0.01'},
      {name: 'Disney (DIS)', value: '1,0.01'},
      {name: 'Netflix (NFLX)', value: '1,0.01'}
    ],
    'stocks-nasdaq': [
      {name: 'StockXXX', value: '1,0.01'},
      {name: 'Apple (AAPL)', value: '1,0.01'},
      {name: 'Microsoft (MSFT)', value: '1,0.01'},
      {name: 'Amazon (AMZN)', value: '1,0.01'},
      {name: 'NVIDIA (NVDA)', value: '1,0.01'},
      {name: 'Meta (META)', value: '1,0.01'},
      {name: 'Tesla (TSLA)', value: '1,0.01'},
      {name: 'Alphabet A (GOOGL)', value: '1,0.01'},
      {name: 'Alphabet C (GOOG)', value: '1,0.01'},
      {name: 'Intel (INTC)', value: '1,0.01'},
      {name: 'AMD (AMD)', value: '1,0.01'},
      {name: 'Netflix (NFLX)', value: '1,0.01'},
      {name: 'Adobe (ADBE)', value: '1,0.01'},
      {name: 'Broadcom (AVGO)', value: '1,0.01'},
      {name: 'Cisco (CSCO)', value: '1,0.01'},
      {name: 'Oracle (ORCL)', value: '1,0.01'},
      {name: 'Salesforce (CRM)', value: '1,0.01'},
      {name: 'PayPal (PYPL)', value: '1,0.01'},
      {name: 'Qualcomm (QCOM)', value: '1,0.01'},
      {name: 'Zoom (ZM)', value: '1,0.01'},
      {name: 'Airbnb (ABNB)', value: '1,0.01'}
    ]
  };
  
  const marketInstruments = instruments[market] || instruments['dax'];
  instrumentSelect.innerHTML = marketInstruments.map(inst => 
    `<option value="${inst.value}">${inst.name}</option>`
  ).join('');
  
  syncInstrumentToRisk();
}

function updateInstruments() {
  const market = document.getElementById('market-select').value;
  const instrumentSelect = document.getElementById('instrument-select');
  
  // Complete instrument data for all markets
  const instruments = {
    'dax': [
      {name: 'FDAX', value: '12.5,0.5'},
      {name: 'FDXM', value: '5,1'},
      {name: 'FDXS', value: '1,1'}
    ],
    'sp500': [
      {name: 'ES', value: '12.5,0.25'},
      {name: 'MES', value: '1.25,0.25'}
    ],
    'nasdaq': [
      {name: 'NQ', value: '5,0.25'},
      {name: 'MNQ', value: '0.5,0.25'}
    ],
    'dow': [
      {name: 'YM', value: '5,1'},
      {name: 'MYM', value: '0.5,1'}
    ],
    'russell': [
      {name: 'RTY', value: '5,0.1'},
      {name: 'M2K', value: '0.5,0.1'}
    ],
    'eurostoxx': [
      {name: 'FESX', value: '10,1'},
      {name: 'FESM', value: '5,1'},
      {name: 'FEXM', value: '1,1'}
    ],
    'forex': [
      {name: '6E (EUR/USD)', value: '12.5,0.0001'},
      {name: 'M6E (Micro EUR)', value: '1.25,0.0001'},
      {name: '6B (GBP/USD)', value: '6.25,0.0001'},
      {name: 'M6B (Micro GBP)', value: '0.625,0.0001'},
      {name: '6J (USD/JPY)', value: '12.5,0.000001'},
      {name: 'MJY (Micro JPY)', value: '1.25,0.000001'},
      {name: '6A (AUD/USD)', value: '10,0.0001'},
      {name: '6C (CAD/USD)', value: '10,0.0001'},
      {name: '6S (CHF/USD)', value: '12.5,0.0001'}
    ],
    'commodities': [
      {name: 'GC (Gold)', value: '10,0.1'},
      {name: 'MGC (Micro Gold)', value: '1,0.1'},
      {name: 'SI (Silver)', value: '5,0.01'},
      {name: 'SIL (Micro Silver)', value: '0.5,0.01'},
      {name: 'CL (Crude Oil)', value: '10,0.01'},
      {name: 'MCL (Micro Oil)', value: '1,0.01'},
      {name: 'NG (Natural Gas)', value: '10,0.001'},
      {name: 'HG (Copper)', value: '12.5,0.0005'}
    ],
    'bonds': [
      {name: 'FGBL (Bund)', value: '10,0.01'},
      {name: 'FGBM (Bobl)', value: '10,0.01'},
      {name: 'FGBS (Schatz)', value: '10,0.01'},
      {name: 'ZB (30Y T-Bond)', value: '31.25,0.03125'},
      {name: 'ZN (10Y T-Note)', value: '15.625,0.015625'},
      {name: 'ZF (5Y T-Note)', value: '7.8125,0.0078125'},
      {name: 'ZT (2Y T-Note)', value: '7.8125,0.00390625'}
    ],
    'stocks-dax': [
      {name: 'StockXXX', value: '1,0.01'},
      {name: 'Adidas', value: '1,0.01'},
      {name: 'Airbus', value: '1,0.01'},
      {name: 'Allianz', value: '1,0.01'},
      {name: 'BASF', value: '1,0.01'},
      {name: 'Bayer', value: '1,0.01'},
      {name: 'BMW', value: '1,0.01'},
      {name: 'Continental', value: '1,0.01'},
      {name: 'Deutsche Bank', value: '1,0.01'},
      {name: 'Deutsche Post', value: '1,0.01'},
      {name: 'Deutsche Telekom', value: '1,0.01'},
      {name: 'E.ON', value: '1,0.01'},
      {name: 'Fresenius', value: '1,0.01'},
      {name: 'Infineon', value: '1,0.01'},
      {name: 'Mercedes-Benz', value: '1,0.01'},
      {name: 'Munich Re', value: '1,0.01'},
      {name: 'Porsche AG', value: '1,0.01'},
      {name: 'SAP', value: '1,0.01'},
      {name: 'Siemens', value: '1,0.01'},
      {name: 'Volkswagen', value: '1,0.01'},
      {name: 'Vonovia', value: '1,0.01'}
    ],
    'stocks-sp500': [
      {name: 'StockXXX', value: '1,0.01'},
      {name: 'Apple (AAPL)', value: '1,0.01'},
      {name: 'Microsoft (MSFT)', value: '1,0.01'},
      {name: 'Amazon (AMZN)', value: '1,0.01'},
      {name: 'NVIDIA (NVDA)', value: '1,0.01'},
      {name: 'Alphabet A (GOOGL)', value: '1,0.01'},
      {name: 'Meta (META)', value: '1,0.01'},
      {name: 'Tesla (TSLA)', value: '1,0.01'},
      {name: 'Berkshire B (BRK.B)', value: '1,0.01'},
      {name: 'JPMorgan (JPM)', value: '1,0.01'},
      {name: 'UnitedHealth (UNH)', value: '1,0.01'},
      {name: 'Visa (V)', value: '1,0.01'},
      {name: 'Johnson&Johnson (JNJ)', value: '1,0.01'},
      {name: 'Walmart (WMT)', value: '1,0.01'},
      {name: 'Procter&Gamble (PG)', value: '1,0.01'},
      {name: 'Mastercard (MA)', value: '1,0.01'},
      {name: 'Home Depot (HD)', value: '1,0.01'},
      {name: 'Chevron (CVX)', value: '1,0.01'},
      {name: 'Coca-Cola (KO)', value: '1,0.01'},
      {name: 'Disney (DIS)', value: '1,0.01'},
      {name: 'Netflix (NFLX)', value: '1,0.01'}
    ],
    'stocks-nasdaq': [
      {name: 'StockXXX', value: '1,0.01'},
      {name: 'Apple (AAPL)', value: '1,0.01'},
      {name: 'Microsoft (MSFT)', value: '1,0.01'},
      {name: 'Amazon (AMZN)', value: '1,0.01'},
      {name: 'NVIDIA (NVDA)', value: '1,0.01'},
      {name: 'Meta (META)', value: '1,0.01'},
      {name: 'Tesla (TSLA)', value: '1,0.01'},
      {name: 'Alphabet A (GOOGL)', value: '1,0.01'},
      {name: 'Alphabet C (GOOG)', value: '1,0.01'},
      {name: 'Intel (INTC)', value: '1,0.01'},
      {name: 'AMD (AMD)', value: '1,0.01'},
      {name: 'Netflix (NFLX)', value: '1,0.01'},
      {name: 'Adobe (ADBE)', value: '1,0.01'},
      {name: 'Broadcom (AVGO)', value: '1,0.01'},
      {name: 'Cisco (CSCO)', value: '1,0.01'},
      {name: 'Oracle (ORCL)', value: '1,0.01'},
      {name: 'Salesforce (CRM)', value: '1,0.01'},
      {name: 'PayPal (PYPL)', value: '1,0.01'},
      {name: 'Qualcomm (QCOM)', value: '1,0.01'},
      {name: 'Zoom (ZM)', value: '1,0.01'},
      {name: 'Airbnb (ABNB)', value: '1,0.01'}
    ]
  };
  
  const marketInstruments = instruments[market] || instruments['dax'];
  instrumentSelect.innerHTML = marketInstruments.map(inst => 
    `<option value="${inst.value}">${inst.name}</option>`
  ).join('');
  
  calculatePosition();
}

function updateAccountSelect() {
  const select = document.getElementById('account-select');
  select.innerHTML = accounts.map(a => 
    `<option value="${a.id}">${a.name} ${a.isMain ? '(Haupt)' : ''}</option>`
  ).join('');
  
  if (mainAccount) {
    select.value = mainAccount.id;
  }
}

function updateAccountBalance() {
  const accountId = parseInt(document.getElementById('account-select').value);
  const selectedAccount = accounts.find(a => a.id === accountId);
  
  if (selectedAccount) {
    document.getElementById('account-balance').value = selectedAccount.currentBalance;
    const riskAmount = selectedAccount.currentBalance * (currentRisk / 100);
    document.getElementById('risk-amount').value = `${selectedAccount.currency || 'EUR'} ${riskAmount.toFixed(0)}`;
    calculatePosition();
  }
}

function updateStrategySelect() {
  const select = document.getElementById('active-strategy');
  select.innerHTML = '<option value="">-- Wähle Strategie --</option>' +
    strategies.map(s => 
      `<option value="${s.id}">${s.name}</option>`
    ).join('');
}

function updateReports() {
  updateAllAccountBalances();
  const closedTrades = trades.filter(t => t.status === 'Closed');
  const winningTrades = closedTrades.filter(t => t.pl > 0);
  const losingTrades = closedTrades.filter(t => t.pl < 0);
  const breakevenTrades = closedTrades.filter(t => t.pl === 0);
  
  // Basic Metrics
  const totalPL = closedTrades.reduce((sum, t) => sum + t.pl, 0);
  const winRate = closedTrades.length > 0 ? (winningTrades.length / closedTrades.length * 100).toFixed(1) : 0;
  const totalWins = winningTrades.reduce((sum, t) => sum + t.pl, 0);
  const totalLosses = Math.abs(losingTrades.reduce((sum, t) => sum + t.pl, 0));
  const avgWin = winningTrades.length > 0 ? totalWins / winningTrades.length : 0;
  const avgLoss = losingTrades.length > 0 ? totalLosses / losingTrades.length : 0;
  
  // Profit Factor
  const profitFactor = totalLosses > 0 ? (totalWins / totalLosses).toFixed(2) : totalWins > 0 ? '∞' : '0.00';
  
  // Payoff Ratio
  const payoffRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '∞' : '0.00';
  
  // Expectancy
  const expectancy = closedTrades.length > 0 ? totalPL / closedTrades.length : 0;
  
  // Maximum Drawdown
  const maxDrawdown = calculateMaxDrawdown(closedTrades);
  
  // Consecutive Wins/Losses
  const { maxConsecWins, maxConsecLosses } = calculateConsecutive(closedTrades);
  
  // Update Display
  document.getElementById('report-total-pl').textContent = `€${totalPL.toFixed(2)}`;
  document.getElementById('report-total-pl').style.color = totalPL > 0 ? '#10b981' : totalPL < 0 ? '#ef4444' : '#94a3b8';
  document.getElementById('report-win-rate').textContent = `${winRate}%`;
  document.getElementById('report-win-rate').style.color = winRate >= 50 ? '#10b981' : winRate >= 40 ? '#f59e0b' : '#ef4444';
  document.getElementById('report-avg-win').textContent = `€${avgWin.toFixed(2)}`;
  document.getElementById('report-avg-loss').textContent = `€${avgLoss.toFixed(2)}`;
  
  document.getElementById('report-profit-factor').textContent = profitFactor;
  document.getElementById('report-profit-factor').style.color = parseFloat(profitFactor) > 1.5 ? '#10b981' : parseFloat(profitFactor) > 1 ? '#f59e0b' : '#ef4444';
  document.getElementById('report-payoff-ratio').textContent = payoffRatio;
  document.getElementById('report-expectancy').textContent = `€${expectancy.toFixed(2)}`;
  document.getElementById('report-expectancy').style.color = expectancy > 0 ? '#10b981' : expectancy < 0 ? '#ef4444' : '#94a3b8';
  document.getElementById('report-max-drawdown').textContent = `€${maxDrawdown.toFixed(2)}`;
  
  document.getElementById('report-total-trades').textContent = closedTrades.length;
  document.getElementById('report-winners').textContent = winningTrades.length;
  document.getElementById('report-losers').textContent = losingTrades.length;
  document.getElementById('report-breakeven').textContent = breakevenTrades.length;
  document.getElementById('report-max-consec-win').textContent = maxConsecWins;
  document.getElementById('report-max-consec-loss').textContent = maxConsecLosses;
  
  // Generate Charts
  updateEquityChart();
  updatePLDistributionChart();
  updateWinLossPieChart();
  
  // Generate Tables
  updateMonthlyPerformance();
  updateBestWorstTrades();
  updateStrategyPerformance();
  updateInstrumentPerformance();
}

function calculateMaxDrawdown(trades) {
  if (trades.length === 0) return 0;
  
  let balance = 0;
  let peak = 0;
  let maxDrawdown = 0;
  
  // Sort trades by date
  const sortedTrades = [...trades].sort((a, b) => {
    const dateA = new Date(a.date || 0);
    const dateB = new Date(b.date || 0);
    return dateA - dateB;
  });
  
  sortedTrades.forEach(trade => {
    balance += trade.pl;
    if (balance > peak) {
      peak = balance;
    }
    const drawdown = peak - balance;
    if (drawdown > maxDrawdown) {
      maxDrawdown = drawdown;
    }
  });
  
  return maxDrawdown;
}

function calculateConsecutive(trades) {
  let maxConsecWins = 0;
  let maxConsecLosses = 0;
  let currentWins = 0;
  let currentLosses = 0;
  
  trades.forEach(trade => {
    if (trade.pl > 0) {
      currentWins++;
      currentLosses = 0;
      maxConsecWins = Math.max(maxConsecWins, currentWins);
    } else if (trade.pl < 0) {
      currentLosses++;
      currentWins = 0;
      maxConsecLosses = Math.max(maxConsecLosses, currentLosses);
    }
  });
  
  return { maxConsecWins, maxConsecLosses };
}

function updateEquityChart() {
  const ctx = document.getElementById('equity-chart');
  if (!ctx) return;
  
  const closedTrades = trades.filter(t => t.status === 'Closed');
  
  // Sort trades by date
  const sortedTrades = [...closedTrades].sort((a, b) => {
    const dateA = new Date(a.date || 0);
    const dateB = new Date(b.date || 0);
    return dateA - dateB;
  });
  
  let balance = 0;
  const equityData = [{ x: 'Start', y: 0 }];
  
  sortedTrades.forEach((trade, index) => {
    balance += trade.pl;
    equityData.push({
      x: trade.date || `Trade ${index + 1}`,
      y: balance
    });
  });
  
  // Clear any existing chart
  if (window.equityChart) {
    window.equityChart.destroy();
  }
  
  // Create chart using Canvas API (since Chart.js might not be available)
  const canvas = ctx.getContext('2d');
  const width = ctx.width = ctx.offsetWidth;
  const height = ctx.height = ctx.offsetHeight;
  
  // Simple line chart drawing
  drawLineChart(canvas, width, height, equityData, '#10b981');
}

function updatePLDistributionChart() {
  const ctx = document.getElementById('pl-distribution-chart');
  if (!ctx) return;
  
  const closedTrades = trades.filter(t => t.status === 'Closed');
  const plValues = closedTrades.map(t => t.pl);
  
  // Create histogram bins
  const bins = createHistogramBins(plValues, 10);
  
  const canvas = ctx.getContext('2d');
  const width = ctx.width = ctx.offsetWidth;
  const height = ctx.height = ctx.offsetHeight;
  
  drawBarChart(canvas, width, height, bins);
}

function updateWinLossPieChart() {
  const ctx = document.getElementById('win-loss-pie-chart');
  if (!ctx) return;
  
  const closedTrades = trades.filter(t => t.status === 'Closed');
  const winners = closedTrades.filter(t => t.pl > 0).length;
  const losers = closedTrades.filter(t => t.pl < 0).length;
  const breakeven = closedTrades.filter(t => t.pl === 0).length;
  
  const canvas = ctx.getContext('2d');
  const width = ctx.width = ctx.offsetWidth;
  const height = ctx.height = ctx.offsetHeight;
  
  drawPieChart(canvas, width, height, [
    { label: 'Gewinner', value: winners, color: '#10b981' },
    { label: 'Verlierer', value: losers, color: '#ef4444' },
    { label: 'Breakeven', value: breakeven, color: '#94a3b8' }
  ]);
}

// Simple chart drawing functions
function drawLineChart(ctx, width, height, data, color) {
  if (data.length === 0) return;
  
  // Clear canvas
  ctx.clearRect(0, 0, width, height);
  
  // Calculate scales
  const padding = 40;
  const chartWidth = width - padding * 2;
  const chartHeight = height - padding * 2;
  
  const maxY = Math.max(...data.map(d => d.y));
  const minY = Math.min(...data.map(d => d.y));
  const range = maxY - minY || 1;
  
  // Draw axes
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, height - padding);
  ctx.lineTo(width - padding, height - padding);
  ctx.stroke();
  
  // Draw zero line if needed
  if (minY < 0 && maxY > 0) {
    const zeroY = height - padding - ((0 - minY) / range * chartHeight);
    ctx.strokeStyle = '#64748b';
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(padding, zeroY);
    ctx.lineTo(width - padding, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);
  }
  
  // Draw line
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  data.forEach((point, i) => {
    const x = padding + (i / (data.length - 1)) * chartWidth;
    const y = height - padding - ((point.y - minY) / range * chartHeight);
    
    if (i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  
  ctx.stroke();
  
  // Draw labels
  ctx.fillStyle = '#94a3b8';
  ctx.font = '11px sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(maxY.toFixed(0), 5, padding);
  ctx.fillText(minY.toFixed(0), 5, height - padding + 10);
}

function drawBarChart(ctx, width, height, bins) {
  if (bins.length === 0) return;
  
  ctx.clearRect(0, 0, width, height);
  
  const padding = 40;
  const chartWidth = width - padding * 2;
  const chartHeight = height - padding * 2;
  
  const maxCount = Math.max(...bins.map(b => b.count));
  const barWidth = chartWidth / bins.length;
  
  // Draw axes
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, height - padding);
  ctx.lineTo(width - padding, height - padding);
  ctx.stroke();
  
  // Draw bars
  bins.forEach((bin, i) => {
    const x = padding + i * barWidth;
    const barHeight = (bin.count / maxCount) * chartHeight;
    const y = height - padding - barHeight;
    
    ctx.fillStyle = bin.range < 0 ? '#ef4444' : '#10b981';
    ctx.fillRect(x + barWidth * 0.1, y, barWidth * 0.8, barHeight);
  });
}

function drawPieChart(ctx, width, height, data) {
  const total = data.reduce((sum, d) => sum + d.value, 0);
  if (total === 0) return;
  
  ctx.clearRect(0, 0, width, height);
  
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) / 3;
  
  let currentAngle = -Math.PI / 2;
  
  data.forEach(segment => {
    const angle = (segment.value / total) * Math.PI * 2;
    
    ctx.fillStyle = segment.color;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + angle);
    ctx.closePath();
    ctx.fill();
    
    // Draw label
    const labelAngle = currentAngle + angle / 2;
    const labelX = centerX + Math.cos(labelAngle) * (radius * 1.3);
    const labelY = centerY + Math.sin(labelAngle) * (radius * 1.3);
    
    ctx.fillStyle = '#e2e8f0';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`${segment.label}: ${segment.value}`, labelX, labelY);
    
    currentAngle += angle;
  });
}

function createHistogramBins(values, binCount) {
  if (values.length === 0) return [];
  
  const min = Math.min(...values);
  const max = Math.max(...values);
  const binSize = (max - min) / binCount || 1;
  
  const bins = [];
  for (let i = 0; i < binCount; i++) {
    const rangeMin = min + i * binSize;
    const rangeMax = min + (i + 1) * binSize;
    const count = values.filter(v => v >= rangeMin && v < rangeMax).length;
    bins.push({
      range: (rangeMin + rangeMax) / 2,
      count: count
    });
  }
  
  return bins;
}

function updateMonthlyPerformance() {
  const tbody = document.getElementById('monthly-performance-body');
  if (!tbody) return;
  
  const closedTrades = trades.filter(t => t.status === 'Closed');
  
  // Group trades by month
  const monthlyData = {};
  
  closedTrades.forEach(trade => {
    const date = new Date(trade.date || Date.now());
    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = {
        trades: [],
        winners: 0,
        losers: 0,
        totalPL: 0,
        maxDD: 0
      };
    }
    
    monthlyData[monthKey].trades.push(trade);
    if (trade.pl > 0) monthlyData[monthKey].winners++;
    if (trade.pl < 0) monthlyData[monthKey].losers++;
    monthlyData[monthKey].totalPL += trade.pl;
  });
  
  // Calculate monthly statistics
  tbody.innerHTML = Object.entries(monthlyData)
    .sort((a, b) => b[0].localeCompare(a[0]))
    .map(([month, data]) => {
      const winRate = data.trades.length > 0 ? ((data.winners / data.trades.length) * 100).toFixed(1) : 0;
      const avgTrade = data.trades.length > 0 ? (data.totalPL / data.trades.length).toFixed(2) : 0;
      const maxDD = calculateMaxDrawdown(data.trades);
      const plColor = data.totalPL > 0 ? '#10b981' : data.totalPL < 0 ? '#ef4444' : '#94a3b8';
      
      return `
        <tr>
          <td>${month}</td>
          <td>${data.trades.length}</td>
          <td style="color: #10b981;">${data.winners}</td>
          <td style="color: #ef4444;">${data.losers}</td>
          <td>${winRate}%</td>
          <td style="color: ${plColor};">€${data.totalPL.toFixed(2)}</td>
          <td style="color: ${plColor};">€${data.totalPL.toFixed(2)}</td>
          <td>€${avgTrade}</td>
          <td style="color: #ef4444;">€${maxDD.toFixed(2)}</td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="9" style="text-align: center; color: #64748b;">Keine Daten vorhanden</td></tr>';
}

function updateBestWorstTrades() {
  const closedTrades = trades.filter(t => t.status === 'Closed');
  
  // Sort trades by P&L
  const sortedTrades = [...closedTrades].sort((a, b) => b.pl - a.pl);
  
  // Best trades
  const bestTrades = sortedTrades.slice(0, 5);
  const bestBody = document.getElementById('best-trades-body');
  if (bestBody) {
    bestBody.innerHTML = bestTrades.map(trade => {
      const rrr = calculateTradeRRR(trade);
      return `
        <tr>
          <td>${trade.id}</td>
          <td>${trade.instrument || '-'}</td>
          <td style="color: #10b981;">€${trade.pl.toFixed(2)}</td>
          <td>${rrr}</td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="4" style="text-align: center; color: #64748b;">Keine Trades</td></tr>';
  }
  
  // Worst trades
  const worstTrades = sortedTrades.slice(-5).reverse();
  const worstBody = document.getElementById('worst-trades-body');
  if (worstBody) {
    worstBody.innerHTML = worstTrades.map(trade => {
      const rrr = calculateTradeRRR(trade);
      return `
        <tr>
          <td>${trade.id}</td>
          <td>${trade.instrument || '-'}</td>
          <td style="color: #ef4444;">€${trade.pl.toFixed(2)}</td>
          <td>${rrr}</td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="4" style="text-align: center; color: #64748b;">Keine Trades</td></tr>';
  }
}

function calculateTradeRRR(trade) {
  if (!trade.entries || !trade.exits || !trade.initialStop) return '-';
  
  const avgEntry = trade.entries.reduce((sum, e) => sum + e.price * e.size, 0) / 
                   trade.entries.reduce((sum, e) => sum + e.size, 0);
  const avgExit = trade.exits.reduce((sum, e) => sum + e.price * e.size, 0) / 
                  trade.exits.reduce((sum, e) => sum + e.size, 0);
  
  const risk = Math.abs(avgEntry - trade.initialStop);
  const reward = Math.abs(avgExit - avgEntry);
  
  return risk > 0 ? (reward / risk).toFixed(2) : '-';
}

function updateStrategyPerformance() {
  const tbody = document.getElementById('strategy-performance-body');
  if (!tbody) return;
  
  const closedTrades = trades.filter(t => t.status === 'Closed');
  
  // Group trades by strategy
  const strategyData = {};
  
  closedTrades.forEach(trade => {
    const strategyId = trade.strategyId || 'none';
    if (!strategyData[strategyId]) {
      strategyData[strategyId] = {
        trades: [],
        winners: 0,
        losers: 0,
        totalWins: 0,
        totalLosses: 0,
        totalPL: 0
      };
    }
    
    strategyData[strategyId].trades.push(trade);
    if (trade.pl > 0) {
      strategyData[strategyId].winners++;
      strategyData[strategyId].totalWins += trade.pl;
    }
    if (trade.pl < 0) {
      strategyData[strategyId].losers++;
      strategyData[strategyId].totalLosses += Math.abs(trade.pl);
    }
    strategyData[strategyId].totalPL += trade.pl;
  });
  
  tbody.innerHTML = Object.entries(strategyData).map(([strategyId, data]) => {
    const strategy = strategies.find(s => s.id == strategyId);
    const strategyName = strategy ? strategy.name : 'Ohne Strategie';
    const winRate = data.trades.length > 0 ? ((data.winners / data.trades.length) * 100).toFixed(1) : 0;
    const avgWin = data.winners > 0 ? (data.totalWins / data.winners).toFixed(2) : 0;
    const avgLoss = data.losers > 0 ? (data.totalLosses / data.losers).toFixed(2) : 0;
    const profitFactor = data.totalLosses > 0 ? (data.totalWins / data.totalLosses).toFixed(2) : data.totalWins > 0 ? '∞' : '0.00';
    const plColor = data.totalPL > 0 ? '#10b981' : data.totalPL < 0 ? '#ef4444' : '#94a3b8';
    
    return `
      <tr>
        <td>${strategyName}</td>
        <td>${data.trades.length}</td>
        <td>${winRate}%</td>
        <td style="color: #10b981;">€${avgWin}</td>
        <td style="color: #ef4444;">€${avgLoss}</td>
        <td style="color: ${plColor};">€${data.totalPL.toFixed(2)}</td>
        <td>${profitFactor}</td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="7" style="text-align: center; color: #64748b;">Keine Strategiedaten vorhanden</td></tr>';
}

function updateInstrumentPerformance() {
  const tbody = document.getElementById('instrument-performance-body');
  if (!tbody) return;
  
  const closedTrades = trades.filter(t => t.status === 'Closed');
  
  // Group trades by instrument
  const instrumentData = {};
  
  closedTrades.forEach(trade => {
    const instrument = trade.instrument || 'Unknown';
    if (!instrumentData[instrument]) {
      instrumentData[instrument] = {
        trades: [],
        winners: 0,
        totalPL: 0,
        bestTrade: 0,
        worstTrade: 0
      };
    }
    
    instrumentData[instrument].trades.push(trade);
    if (trade.pl > 0) instrumentData[instrument].winners++;
    instrumentData[instrument].totalPL += trade.pl;
    
    if (trade.pl > instrumentData[instrument].bestTrade) {
      instrumentData[instrument].bestTrade = trade.pl;
    }
    if (trade.pl < instrumentData[instrument].worstTrade) {
      instrumentData[instrument].worstTrade = trade.pl;
    }
  });
  
  tbody.innerHTML = Object.entries(instrumentData).map(([instrument, data]) => {
    const winRate = data.trades.length > 0 ? ((data.winners / data.trades.length) * 100).toFixed(1) : 0;
    const avgPL = data.trades.length > 0 ? (data.totalPL / data.trades.length).toFixed(2) : 0;
    const plColor = data.totalPL > 0 ? '#10b981' : data.totalPL < 0 ? '#ef4444' : '#94a3b8';
    
    return `
      <tr>
        <td>${instrument}</td>
        <td>${data.trades.length}</td>
        <td>${winRate}%</td>
        <td>€${avgPL}</td>
        <td style="color: ${plColor};">€${data.totalPL.toFixed(2)}</td>
        <td style="color: #10b981;">€${data.bestTrade.toFixed(2)}</td>
        <td style="color: #ef4444;">€${data.worstTrade.toFixed(2)}</td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="7" style="text-align: center; color: #64748b;">Keine Instrumentdaten vorhanden</td></tr>';
}

// Action Functions
function setGear(gear) {
  currentGear = gear;
  document.getElementById('gear-number').textContent = gear;
  
  document.querySelectorAll('.gear-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(`gear-${gear}`).classList.add('active');
  
  if (gear <= 2) {
    setRisk(0.5);
  } else if (gear === 3) {
    setRisk(1);
  } else {
    setRisk(2);
  }
}

function setRisk(risk) {
  currentRisk = risk;
  
  document.querySelectorAll('.risk-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (risk === 0.5) {
    document.getElementById('risk-05').classList.add('active');
  } else if (risk === 1) {
    document.getElementById('risk-1').classList.add('active');
  } else if (risk === 2) {
    document.getElementById('risk-2').classList.add('active');
  }
  
  // Verwende den aktuell gewählten Account, nicht nur mainAccount
  const accountId = parseInt(document.getElementById('account-select').value);
  const selectedAccount = accounts.find(a => a.id === accountId) || mainAccount;
  
  if (selectedAccount) {
    const riskAmount = selectedAccount.currentBalance * (risk / 100);
    document.getElementById('risk-amount').value = `${selectedAccount.currency || 'EUR'} ${riskAmount.toFixed(0)}`;
  }
  
  calculatePosition();
}

function suggestGear() {
  // Get last 10 trading days data
  const equityData = calculateRecentEquityCurve(10);
  const elliottWave = document.getElementById('elliott-wave').value;
  
  // Calculate base gear from equity curve
  const equityScore = analyzeEquityCurve(equityData);
  
  // Get Elliott Wave modifier
  const waveModifier = getElliottWaveModifier(elliottWave);
  
  // Calculate risk level for additional safety checks
  const riskLevel = calculateRiskLevel();
  
  // Calculate drawdown limit
  const drawdownLimit = getDrawdownLimit(equityData);
  
  // Combined calculation
  let suggestedGear = Math.round(equityScore.baseGear + waveModifier);
  
  // Apply drawdown limits
  suggestedGear = Math.min(suggestedGear, drawdownLimit);
  
  // Ensure gear is within valid range (1-5)
  suggestedGear = Math.max(1, Math.min(5, suggestedGear));
  
  // Update UI with detailed explanation
  updateGearSuggestionUI(suggestedGear, equityScore, waveModifier, drawdownLimit);
  
  // Update gear buttons
  document.querySelectorAll('.gear-btn').forEach(btn => {
    btn.classList.remove('suggested');
  });
  document.getElementById(`gear-${suggestedGear}`).classList.add('suggested');
  
  return suggestedGear;
}

function calculateRecentEquityCurve(days) {
  const closedTrades = trades.filter(t => t.status === 'Closed');
  
  // Get current date
  const now = new Date();
  const cutoffDate = new Date(now);
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  // Filter trades from last N days
  const recentTrades = closedTrades.filter(trade => {
    const tradeDate = new Date(trade.date || 0);
    return tradeDate >= cutoffDate;
  });
  
  // If no recent trades, use last N trades instead
  if (recentTrades.length === 0 && closedTrades.length > 0) {
    const sortedTrades = [...closedTrades].sort((a, b) => {
      const dateA = new Date(a.date || 0);
      const dateB = new Date(b.date || 0);
      return dateB - dateA;
    });
    recentTrades.push(...sortedTrades.slice(0, Math.min(10, sortedTrades.length)));
  }
  
  // Calculate cumulative P&L
  let balance = 0;
  const equityPoints = [];
  
  recentTrades.forEach((trade, index) => {
    balance += trade.pl;
    equityPoints.push({
      index: index,
      balance: balance,
      pl: trade.pl,
      date: trade.date
    });
  });
  
  return equityPoints;
}

function analyzeEquityCurve(equityData) {
  if (equityData.length === 0) {
    return {
      baseGear: 3,
      trend: 'neutral',
      volatility: 'normal',
      drawdown: 0,
      score: 50
    };
  }
  
  // Calculate trend using linear regression
  const trend = calculateTrend(equityData);
  
  // Calculate volatility
  const volatility = calculateVolatility(equityData);
  
  // Calculate current drawdown
  const drawdown = calculateCurrentDrawdown(equityData);
  
  // Calculate consecutive wins/losses
  const streaks = calculateStreaks(equityData);
  
  // Base gear calculation
  let baseGear = 3; // Start neutral
  let score = 50;
  
  // Trend adjustment
  if (trend > 0.5) {
    baseGear += 1;
    score += 20;
  } else if (trend > 0.2) {
    baseGear += 0.5;
    score += 10;
  } else if (trend < -0.5) {
    baseGear -= 1;
    score -= 20;
  } else if (trend < -0.2) {
    baseGear -= 0.5;
    score -= 10;
  }
  
  // Volatility adjustment
  if (volatility > 2) {
    baseGear -= 1;
    score -= 15;
  } else if (volatility < 0.5) {
    baseGear += 0.5;
    score += 10;
  }
  
  // Streak adjustment
  if (streaks.currentWinStreak >= 3) {
    baseGear += 0.5;
    score += 10;
  } else if (streaks.currentLossStreak >= 3) {
    baseGear -= 1;
    score -= 20;
  }
  
  return {
    baseGear: baseGear,
    trend: trend > 0.2 ? 'up' : trend < -0.2 ? 'down' : 'neutral',
    volatility: volatility > 2 ? 'high' : volatility < 0.5 ? 'low' : 'normal',
    drawdown: drawdown,
    score: Math.max(0, Math.min(100, score)),
    streaks: streaks
  };
}

function calculateTrend(equityData) {
  if (equityData.length < 2) return 0;
  
  // Simple linear regression
  const n = equityData.length;
  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
  
  equityData.forEach((point, i) => {
    sumX += i;
    sumY += point.balance;
    sumXY += i * point.balance;
    sumX2 += i * i;
  });
  
  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  
  // Normalize slope to -1 to 1 range
  const avgBalance = sumY / n;
  const normalizedSlope = avgBalance !== 0 ? (slope / Math.abs(avgBalance)) * 10 : 0;
  
  return Math.max(-1, Math.min(1, normalizedSlope));
}

function calculateVolatility(equityData) {
  if (equityData.length < 2) return 1;
  
  const returns = [];
  for (let i = 1; i < equityData.length; i++) {
    const prevBalance = equityData[i-1].balance || 1;
    const change = ((equityData[i].balance - prevBalance) / Math.abs(prevBalance)) * 100;
    returns.push(change);
  }
  
  const avg = returns.reduce((a, b) => a + b, 0) / returns.length;
  const variance = returns.reduce((sum, r) => sum + Math.pow(r - avg, 2), 0) / returns.length;
  
  return Math.sqrt(variance);
}

function calculateCurrentDrawdown(equityData) {
  if (equityData.length === 0) return 0;
  
  const balances = equityData.map(p => p.balance);
  const peak = Math.max(...balances);
  const current = balances[balances.length - 1];
  
  if (peak <= 0) return 0;
  
  const drawdownPercent = ((peak - current) / peak) * 100;
  return Math.max(0, drawdownPercent);
}

function calculateStreaks(equityData) {
  let currentWinStreak = 0;
  let currentLossStreak = 0;
  
  for (let i = equityData.length - 1; i >= 0; i--) {
    if (equityData[i].pl > 0) {
      if (currentLossStreak > 0) break;
      currentWinStreak++;
    } else if (equityData[i].pl < 0) {
      if (currentWinStreak > 0) break;
      currentLossStreak++;
    }
  }
  
  return { currentWinStreak, currentLossStreak };
}

function getElliottWaveModifier(wavePattern) {
  const modifiers = {
    'Impulse wave': 0.5,
    'Corrective wave': -1,
    'Wave 3 (strongest)': 1.5,
    'Wave 5 (final)': -0.5,
    'Wave 1': 0,
    'Wave 2': -1,
    'Wave 4': -0.5
  };
  
  return modifiers[wavePattern] || 0;
}

function getDrawdownLimit(equityData) {
  const drawdown = calculateCurrentDrawdown(equityData);
  
  if (drawdown >= 20) return 1;
  if (drawdown >= 15) return 2;
  if (drawdown >= 10) return 3;
  if (drawdown >= 5) return 4;
  return 5;
}

function updateGearSuggestionUI(suggestedGear, equityScore, waveModifier, drawdownLimit) {
  const suggestionDiv = document.getElementById('gear-suggestion');
  
  // Create detailed explanation
  let explanation = `Empfohlen: Gear ${suggestedGear}`;
  
  // Draw mini equity chart
  drawMiniEquityChart();
  
  // Add equity curve mini visualization
  const gearDisplay = document.getElementById('gear-display');
  
  // Remove old analysis box if exists
  const oldAnalysis = document.getElementById('gear-analysis-box');
  if (oldAnalysis) oldAnalysis.remove();
  
  // Create new analysis box
  const analysisBox = document.createElement('div');
  analysisBox.id = 'gear-analysis-box';
  analysisBox.style.cssText = `
    position: absolute;
    bottom: -10px;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 0 0 16px 16px;
    font-size: 11px;
    color: white;
  `;
  
  // Trend indicator
  const trendIcon = equityScore.trend === 'up' ? '📈' : 
                    equityScore.trend === 'down' ? '📉' : '➡️';
  const trendColor = equityScore.trend === 'up' ? '#10b981' : 
                     equityScore.trend === 'down' ? '#ef4444' : '#f59e0b';
  
  // Wave indicator  
  const waveBonus = waveModifier > 0 ? `+${waveModifier}` : waveModifier.toString();
  const waveColor = waveModifier > 0 ? '#10b981' : waveModifier < 0 ? '#ef4444' : '#94a3b8';
  
  analysisBox.innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center;">
      <div>
        <div style="opacity: 0.7;">Equity</div>
        <div style="font-weight: 600; color: ${trendColor};">
          ${trendIcon} ${equityScore.baseGear.toFixed(1)}
        </div>
      </div>
      <div>
        <div style="opacity: 0.7;">Wave</div>
        <div style="font-weight: 600; color: ${waveColor};">
          ${waveBonus}
        </div>
      </div>
      <div>
        <div style="opacity: 0.7;">DD-Limit</div>
        <div style="font-weight: 600; color: ${drawdownLimit < 5 ? '#ef4444' : '#10b981'};">
          Max ${drawdownLimit}
        </div>
      </div>
    </div>
    ${equityScore.streaks && (equityScore.streaks.currentWinStreak >= 3 || equityScore.streaks.currentLossStreak >= 3) ? 
      `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
        ${equityScore.streaks.currentWinStreak >= 3 ? 
          `<span style="color: #10b981;">🔥 ${equityScore.streaks.currentWinStreak} Gewinne in Folge</span>` :
          `<span style="color: #ef4444;">⚠️ ${equityScore.streaks.currentLossStreak} Verluste in Folge</span>`}
      </div>` : ''}
    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
      <div style="opacity: 0.7;">Equity Score: ${equityScore.score}/100</div>
    </div>
  `;
  
  gearDisplay.appendChild(analysisBox);
  
  // Update suggestion text
  suggestionDiv.textContent = explanation;
}

function drawMiniEquityChart() {
  const canvas = document.getElementById('mini-equity-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const equityData = calculateRecentEquityCurve(10);
  
  // Set canvas size
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (equityData.length === 0) {
    // Show no data message
    ctx.fillStyle = '#64748b';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Keine Daten verfügbar', canvas.width / 2, canvas.height / 2);
    return;
  }
  
  // Add starting point at 0
  const chartData = [{ balance: 0 }, ...equityData];
  
  // Calculate min and max
  const balances = chartData.map(d => d.balance);
  const minBalance = Math.min(...balances);
  const maxBalance = Math.max(...balances);
  const range = maxBalance - minBalance || 1;
  
  // Drawing parameters
  const padding = 5;
  const chartWidth = canvas.width - padding * 2;
  const chartHeight = canvas.height - padding * 2;
  
  // Draw zero line
  if (minBalance < 0 && maxBalance > 0) {
    const zeroY = padding + chartHeight - ((0 - minBalance) / range * chartHeight);
    ctx.strokeStyle = '#2d3748';
    ctx.setLineDash([2, 2]);
    ctx.beginPath();
    ctx.moveTo(padding, zeroY);
    ctx.lineTo(canvas.width - padding, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);
  }
  
  // Draw the line
  ctx.strokeStyle = chartData[chartData.length - 1].balance >= 0 ? '#10b981' : '#ef4444';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  chartData.forEach((point, i) => {
    const x = padding + (i / (chartData.length - 1)) * chartWidth;
    const y = padding + chartHeight - ((point.balance - minBalance) / range * chartHeight);
    
    if (i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  
  ctx.stroke();
  
  // Draw points
  chartData.forEach((point, i) => {
    if (i === 0) return; // Skip starting point
    
    const x = padding + (i / (chartData.length - 1)) * chartWidth;
    const y = padding + chartHeight - ((point.balance - minBalance) / range * chartHeight);
    
    // Point color based on P&L
    if (point.pl !== undefined) {
      ctx.fillStyle = point.pl > 0 ? '#10b981' : point.pl < 0 ? '#ef4444' : '#94a3b8';
    } else {
      ctx.fillStyle = '#94a3b8';
    }
    
    ctx.beginPath();
    ctx.arc(x, y, 2, 0, Math.PI * 2);
    ctx.fill();
  });
  
  // Draw current value
  if (chartData.length > 0) {
    const lastValue = chartData[chartData.length - 1].balance;
    ctx.fillStyle = lastValue >= 0 ? '#10b981' : '#ef4444';
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(`€${lastValue.toFixed(0)}`, canvas.width - padding, 15);
  }
}

function suggestStrategies() {
  // Debug: Zeige alle Strategien und deren Bereiche
  console.log('Current Advantage for Strategy Matching:', currentAdvantage);
  console.log('Available Strategies:', strategies);
  
  const matchingStrategies = strategies.filter(s => {
    // Long Range Check
    const inLongRange = (s.longMinAdvantage !== null && s.longMaxAdvantage !== null) && 
                        (currentAdvantage >= s.longMinAdvantage && currentAdvantage <= s.longMaxAdvantage);
    
    // Short Range Check
    const inShortRange = (s.shortMinAdvantage !== null && s.shortMaxAdvantage !== null) &&
                         (currentAdvantage <= s.shortMaxAdvantage && currentAdvantage >= s.shortMinAdvantage);
    
    if (inLongRange) {
      console.log(`${s.name} matches LONG range: ${currentAdvantage} is between ${s.longMinAdvantage} and ${s.longMaxAdvantage}`);
    }
    if (inShortRange) {
      console.log(`${s.name} matches SHORT range: ${currentAdvantage} is between ${s.shortMinAdvantage} and ${s.shortMaxAdvantage}`);
    }
    
    return inLongRange || inShortRange;
  });
  
  console.log('Matching Strategies:', matchingStrategies);
  
  const suggestionDiv = document.getElementById('strategy-suggestions');
  const suggestionList = document.getElementById('suggested-strategies');
  
  // Immer anzeigen, auch wenn keine Strategien matchen - mit entsprechender Meldung
  if (matchingStrategies.length > 0) {
    suggestionDiv.style.display = 'block';
    suggestionList.innerHTML = matchingStrategies.map(s => 
      `<span class="suggestion-tag" onclick="selectStrategy(${s.id})">${s.name}</span>`
    ).join('');
  } else {
    // Zeige Info, dass keine Strategien für diesen Bereich vorhanden sind
    suggestionDiv.style.display = 'block';
    suggestionList.innerHTML = `<span style="color: #64748b; font-size: 12px;">
      Keine Strategien für ${currentAdvantage}% Vorteil definiert
    </span>`;
  }
}

function selectStrategy(strategyId) {
  const strategy = strategies.find(s => s.id === strategyId);
  if (!strategy) return;
  
  document.getElementById('active-strategy').value = strategyId;
  
  // Determine direction based on current advantage
  let direction = 'NEUTRAL';
  if (strategy.longMinAdvantage !== null && strategy.longMaxAdvantage !== null &&
      currentAdvantage >= strategy.longMinAdvantage && currentAdvantage <= strategy.longMaxAdvantage) {
    direction = 'LONG';
  } else if (strategy.shortMinAdvantage !== null && strategy.shortMaxAdvantage !== null &&
             currentAdvantage <= strategy.shortMaxAdvantage && currentAdvantage >= strategy.shortMinAdvantage) {
    direction = 'SHORT';
  }
  
  // Zone indicators
  const zones = strategy.zones || { green: true, orange: false, red: false };
  const zoneDisplay = `
    <div style="display: flex; gap: 4px; align-items: center;">
      ${zones.green ? '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;" title="Grüne Zone"></span>' : ''}
      ${zones.orange ? '<span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;" title="Orange Zone"></span>' : ''}
      ${zones.red ? '<span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;" title="Rote Zone"></span>' : ''}
    </div>
  `;
  
  // Aggressiveness range
  let aggrMin, aggrMax;
  if (strategy.aggressivenessMin !== undefined && strategy.aggressivenessMax !== undefined) {
    aggrMin = strategy.aggressivenessMin;
    aggrMax = strategy.aggressivenessMax;
  } else {
    // Backward compatibility
    const singleValue = strategy.aggressiveness || 50;
    aggrMin = Math.max(0, singleValue - 25);
    aggrMax = Math.min(100, singleValue + 25);
  }
  
  const avgAggr = (aggrMin + aggrMax) / 2;
  const aggrColor = avgAggr > 70 ? '#ef4444' : avgAggr > 40 ? '#f59e0b' : '#10b981';
  
  // Show strategy details
  const detailDiv = document.getElementById('strategy-detail-display');
  detailDiv.innerHTML = `
    <div style="padding: 12px; background: #1e293b; border-radius: 8px;">
      <div style="display: grid; gap: 8px; font-size: 13px;">
        <div><strong>Name:</strong> ${strategy.name}</div>
        <div><strong>Typ:</strong> ${strategy.type}</div>
        <div><strong>Direction:</strong> <span style="color: ${direction === 'LONG' ? '#10b981' : direction === 'SHORT' ? '#ef4444' : '#f59e0b'}">${direction}</span></div>
        ${strategy.description ? `<div><strong>Beschreibung:</strong> ${strategy.description}</div>` : ''}
        ${strategy.entry ? `<div><strong>Einstieg:</strong> ${strategy.entry}</div>` : ''}
        ${strategy.exit ? `<div><strong>Ausstieg:</strong> ${strategy.exit}</div>` : ''}
        ${strategy.management ? `<div><strong>Management:</strong> ${strategy.management}</div>` : ''}
        <div>
          <strong>Aggressivität:</strong> ${aggrMin}% - ${aggrMax}%
          <div style="background: #0a0e1a; height: 6px; border-radius: 3px; position: relative; margin-top: 4px;">
            <div style="position: absolute; left: ${aggrMin}%; width: ${aggrMax - aggrMin}%; 
                        height: 100%; background: ${aggrColor}; border-radius: 3px;"></div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <strong>Kontozonen:</strong> ${zoneDisplay}
        </div>
        <div><strong>Long Range:</strong> ${strategy.longMinAdvantage}% bis ${strategy.longMaxAdvantage}%</div>
        <div><strong>Short Range:</strong> ${strategy.shortMinAdvantage}% bis ${strategy.shortMaxAdvantage}%</div>
        <div><strong>RRR Target:</strong> ${strategy.rrr}</div>
      </div>
    </div>
  `;
  
  showNotification(`Strategie "${strategy.name}" ausgewählt`, 'success');
}

function syncInstrumentToRisk() {
  const maMarket = document.getElementById('ma-market-select').value;
  const maInstrument = document.getElementById('ma-instrument-select').value;
  
  // Update Risk & Trade Planning
  document.getElementById('market-select').value = maMarket;
  updateInstruments();
  
  // Wichtig: Wert nach dem Update der Liste setzen
  setTimeout(() => {
    document.getElementById('instrument-select').value = maInstrument;
    calculatePosition();
  }, 10);
}

function saveAnalysisToDashboard() {
  const recentAnalyses = JSON.parse(localStorage.getItem('recentAnalyses') || '[]');
  const analysis = {
    date: new Date().toLocaleString('de-DE'),
    instrument: document.getElementById('ma-instrument-select').selectedOptions[0]?.text || 'Unknown',
    advantage: currentAdvantage,
    timestamp: Date.now()
  };
  
  recentAnalyses.push(analysis);
  if (recentAnalyses.length > 20) {
    recentAnalyses.shift();
  }
  
  localStorage.setItem('recentAnalyses', JSON.stringify(recentAnalyses));
  updateDashboard();
  showNotification('Analyse gespeichert', 'success');
}

function addToTradeLog() {
  const accountId = parseInt(document.getElementById('account-select').value);
  const selectedAccount = accounts.find(a => a.id === accountId);
  
  if (!selectedAccount) {
    showNotification('Bitte wähle ein Account', 'error');
    return;
  }
  
  const entry = parseFloat(document.getElementById('entry-price').value);
  const stop = parseFloat(document.getElementById('stop-price').value);
  const target = parseFloat(document.getElementById('target-price').value);
  const instrumentText = document.getElementById('instrument-select').selectedOptions[0]?.text || '';
  const activeStrategyId = document.getElementById('active-strategy').value;
  
  // Korrekte Richtungserkennung
  let direction = '';
  if (stop < entry && target > entry) {
    direction = 'LONG';
  } else if (stop > entry && target < entry) {
    direction = 'SHORT';
  } else {
    showNotification('Ungültige Trade-Konfiguration', 'error');
    return;
  }
  
  // Öffne Modal mit vorausgefüllten Daten
  currentTradeId = null;
  const modal = document.getElementById('trade-modal');
  
  // Populate account select
  const tradeAccountSelect = document.getElementById('trade-account');
  tradeAccountSelect.innerHTML = accounts.map(a => 
    `<option value="${a.id}">${a.name}</option>`
  ).join('');
  
  // Populate strategy select
  const tradeStrategySelect = document.getElementById('trade-strategy');
  tradeStrategySelect.innerHTML = '<option value="">-- Keine --</option>' +
    strategies.map(s => 
      `<option value="${s.id}">${s.name}</option>`
    ).join('');
  
  // Fülle Formular mit aktuellen Daten
  document.getElementById('trade-id').value = getNextTradeId();
  document.getElementById('trade-account').value = accountId;
  document.getElementById('trade-instrument').value = instrumentText;
  document.getElementById('trade-currency').value = selectedAccount.currency || 'EUR';
  document.getElementById('trade-direction').value = direction;
  document.getElementById('trade-initial-stop').value = stop;
  document.getElementById('trade-status').value = 'Open';
  document.getElementById('trade-strategy').value = activeStrategyId || '';
  document.getElementById('trade-management').value = '';
  document.getElementById('trade-errors').value = '';
  
  // Clear and add entry point with current data
  const entryContainer = document.getElementById('entry-points-container');
  entryContainer.innerHTML = '';
  addEntryPoint('', entry, document.getElementById('position-size').textContent);
  
  // Clear exit points - user can add if needed
  const exitContainer = document.getElementById('exit-points-container');
  exitContainer.innerHTML = '';
  
  modal.classList.add('active');
  showNotification('Trade Details vorausgefüllt - bitte vervollständigen', 'success');
}

function executeAction() {
  const action = document.getElementById('action-text').textContent;
  const size = document.getElementById('position-size').textContent;
  
  if (action !== 'WAIT' && size > 0) {
    addToTradeLog();
    showNotification(`${action} Order ausgeführt: ${size} Kontrakte`, 'success');
  } else {
    showNotification('Ausführung nicht möglich: Marktbedingungen prüfen', 'error');
  }
}

// Render Functions
function renderAccounts() {
  const container = document.getElementById('accounts-list');
  container.innerHTML = accounts.map(account => {
    // Calculate P&L from trades
    const accountTrades = trades.filter(t => t.accountId === account.id && t.status === 'Closed');
    const tradingPL = accountTrades.reduce((sum, t) => sum + t.pl, 0);
    
    // Calculate total deposits and withdrawals
    const accountTransactions = transactions.filter(t => t.accountId === account.id);
    const totalDeposits = accountTransactions.filter(t => t.type === 'deposit').reduce((sum, t) => sum + t.amount, 0);
    const totalWithdrawals = accountTransactions.filter(t => t.type === 'withdrawal').reduce((sum, t) => sum + t.amount, 0);
    
    // Display calculations
    const netTransactions = totalDeposits - totalWithdrawals;
    const totalChange = account.currentBalance - account.initialBalance;
    const plPercent = (tradingPL / account.initialBalance * 100).toFixed(1);
    const plColor = tradingPL > 0 ? '#10b981' : tradingPL < 0 ? '#ef4444' : '#94a3b8';
    
    return `
      <div class="account-card ${account.isMain ? 'main-account' : ''}">
        <div class="account-header">
          <div>
            <span class="account-name">${account.name}</span>
            ${account.isMain ? '<span class="main-indicator">HAUPT</span>' : ''}
          </div>
          <div class="account-type">${account.type}</div>
        </div>
        <div style="font-size: 12px; color: #64748b; margin-bottom: 12px;">
          Konto-Nr: ${account.accountNumber || '-'} | Währung: ${account.currency || 'EUR'}
        </div>
        
        <!-- Detailed Balance Breakdown -->
        <div style="background: #1e293b; border-radius: 6px; padding: 10px; margin-bottom: 12px;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
            <div>Anfangskapital: <span style="float: right;">${account.currency} ${account.initialBalance.toLocaleString('de-DE')}</span></div>
            <div>Trading P&L: <span style="float: right; color: ${plColor};">${tradingPL >= 0 ? '+' : ''}${account.currency} ${tradingPL.toFixed(2)}</span></div>
            <div>Einzahlungen: <span style="float: right; color: #10b981;">+${account.currency} ${totalDeposits.toFixed(2)}</span></div>
            <div>Auszahlungen: <span style="float: right; color: #ef4444;">-${account.currency} ${totalWithdrawals.toFixed(2)}</span></div>
          </div>
          <div style="border-top: 1px solid #2d3748; margin-top: 8px; padding-top: 8px; font-weight: 600;">
            Aktuelle Balance: <span style="float: right; color: ${totalChange > 0 ? '#10b981' : totalChange < 0 ? '#ef4444' : '#94a3b8'};">
              ${account.currency} ${account.currentBalance.toLocaleString('de-DE')}
            </span>
          </div>
        </div>
        
        <div class="account-stats">
          <div class="account-stat">
            <div class="account-stat-label">Trading P&L</div>
            <div class="account-stat-value" style="color: ${plColor};">
              ${plPercent}%
            </div>
          </div>
          <div class="account-stat">
            <div class="account-stat-label">Netto Trans.</div>
            <div class="account-stat-value" style="color: ${netTransactions >= 0 ? '#10b981' : '#ef4444'};">
              ${netTransactions >= 0 ? '+' : ''}${account.currency} ${netTransactions.toFixed(0)}
            </div>
          </div>
        </div>
        
        <div class="account-actions">
          <button class="save-button" style="padding: 4px 8px; font-size: 11px;" 
                  onclick="openTransactionModalForAccount(${account.id}, 'deposit')">+ Einzahlung</button>
          <button class="delete-btn" style="padding: 4px 8px; font-size: 11px;" 
                  onclick="openTransactionModalForAccount(${account.id}, 'withdrawal')">- Auszahlung</button>
          ${!account.isMain ? `<button class="main-account-btn" onclick="setMainAccount(${account.id})">Haupt</button>` : ''}
          <button class="edit-btn" onclick="editAccount(${account.id})">Edit</button>
          ${accounts.length > 1 ? `<button class="delete-btn" onclick="deleteAccount(${account.id})">×</button>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  // Also render transaction history when accounts are rendered
  renderTransactionHistory();
}

function openTransactionModalForAccount(accountId, type) {
  openTransactionModal(type);
  document.getElementById('transaction-account').value = accountId;
  updateTransactionPreview();
}

function renderStrategies() {
  const container = document.getElementById('strategies-list');
  console.log('renderStrategies aufgerufen, Anzahl Strategien:', strategies.length);
  
  if (!container) {
    console.error('strategies-list Container nicht gefunden!');
    return;
  }
  
  // Container leeren
  container.innerHTML = '';
  
  // Jede Strategie einzeln rendern
  strategies.forEach(strategy => {
    console.log('Rendere Strategie:', strategy.name, 'mit ID:', strategy.id);
    
    // Create strategy card element
    const strategyCard = document.createElement('div');
    strategyCard.className = 'strategy-card';
    
    // Zone indicators
    const zones = strategy.zones || { green: true, orange: false, red: false };
    let zoneIndicatorsHTML = '<div style="display: flex; gap: 4px; margin-top: 8px;">';
    if (zones.green) zoneIndicatorsHTML += '<span style="display: inline-block; width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></span>';
    if (zones.orange) zoneIndicatorsHTML += '<span style="display: inline-block; width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span>';
    if (zones.red) zoneIndicatorsHTML += '<span style="display: inline-block; width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>';
    zoneIndicatorsHTML += '</div>';
    
    // Aggressiveness range bar
    let aggrMin, aggrMax;
    if (strategy.aggressivenessMin !== undefined && strategy.aggressivenessMax !== undefined) {
      aggrMin = strategy.aggressivenessMin;
      aggrMax = strategy.aggressivenessMax;
    } else {
      const singleValue = strategy.aggressiveness || 50;
      aggrMin = Math.max(0, singleValue - 25);
      aggrMax = Math.min(100, singleValue + 25);
    }
    
    const avgAggr = (aggrMin + aggrMax) / 2;
    const rangeColor = avgAggr > 70 ? '#ef4444' : avgAggr > 40 ? '#f59e0b' : '#10b981';
    
    // Build HTML
    strategyCard.innerHTML = `
        <div class="strategy-header">
          <div class="strategy-name">${strategy.name}</div>
          <div class="strategy-type">${strategy.type}</div>
        </div>
        ${strategy.description ? `
          <div style="font-size: 12px; color: #94a3b8; margin: 8px 0; font-style: italic;">
            "${strategy.description}"
          </div>
        ` : ''}
        <div class="strategy-details">
          <div>Long: ${strategy.longMinAdvantage}% bis ${strategy.longMaxAdvantage}%</div>
          <div>Short: ${strategy.shortMinAdvantage}% bis ${strategy.shortMaxAdvantage}%</div>
          <div>RRR: ${strategy.rrr}</div>
          <div style="grid-column: 1 / -1;">
            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">
              Aggressivität: ${aggrMin}% - ${aggrMax}%
            </div>
            <div style="background: #1e293b; height: 8px; border-radius: 4px; position: relative;">
              <div style="position: absolute; left: ${aggrMin}%; width: ${aggrMax - aggrMin}%; 
                          height: 100%; background: ${rangeColor}; border-radius: 4px;"></div>
            </div>
          </div>
          <div style="grid-column: 1 / -1; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 11px; color: #64748b;">Kontozonen:</span>
          ${zoneIndicatorsHTML}
          </div>
        </div>
      <div class="strategy-actions"></div>
    `;
    
    // Buttons separat erstellen mit korrekten Event-Handlers
    const actionsDiv = strategyCard.querySelector('.strategy-actions');
    
    const editBtn = document.createElement('button');
    editBtn.className = 'edit-btn';
    editBtn.textContent = 'Edit';
    editBtn.onclick = function() {
      window.editStrategy(strategy.id);
    };
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = function() {
      window.deleteStrategy(strategy.id);
    };
    
    actionsDiv.appendChild(editBtn);
    actionsDiv.appendChild(deleteBtn);
    
    // Append to container
    container.appendChild(strategyCard);
  });
}

function renderTrades() {
  const tbody = document.getElementById('trade-log-body');
  tbody.innerHTML = trades.map(trade => {
    const plColor = trade.pl > 0 ? '#10b981' : trade.pl < 0 ? '#ef4444' : '#94a3b8';
    const dirColor = trade.direction === 'LONG' ? '#10b981' : '#ef4444';
    
    // Berechne Gesamtpositionsgröße
    const totalSize = trade.entries && trade.entries.length > 0 
      ? trade.entries.reduce((sum, entry) => sum + (entry.size || 0), 0)
      : 0;
    
    // Formatiere Entry und Exit Preise mit Größen
    const entriesText = trade.entries && trade.entries.length > 0
      ? trade.entries.map(e => `${e.price}@${e.size || 0}`).join(', ')
      : '-';
    
    const exitsText = trade.exits && trade.exits.length > 0 
      ? trade.exits.map(e => `${e.price}@${e.size || 0}`).join(', ')
      : '-';
    
    return `
      <tr>
        <td>${trade.id}</td>
        <td>${trade.accountName}</td>
        <td>${trade.instrument}</td>
        <td>${trade.currency || 'EUR'}</td>
        <td style="color: ${dirColor};">${trade.direction}</td>
        <td style="font-weight: 600;">${totalSize}</td>
        <td style="font-size: 11px;">${entriesText}</td>
        <td style="font-size: 11px;">${exitsText}</td>
        <td>${trade.initialStop || '-'}</td>
        <td style="color: ${plColor};">${trade.pl > 0 ? '+' : ''}${trade.currency || 'EUR'} ${trade.pl.toFixed(2)}</td>
        <td>${trade.status}</td>
        <td>
          <button class="edit-btn" onclick="editTrade(${trade.id})">Edit</button>
          <button class="delete-btn" onclick="deleteTrade(${trade.id})">Delete</button>
        </td>
      </tr>
    `;
  }).join('');
}

// Modal Functions
function openAccountModal() {
  editingAccountId = null;
  document.getElementById('account-modal-title').textContent = 'Neues Account';
  
  // Clear form fields
  document.getElementById('account-name').value = '';
  document.getElementById('account-number').value = '';
  document.getElementById('account-type').value = 'Paper';
  document.getElementById('account-currency').value = 'EUR';
  document.getElementById('account-initial-balance').value = '';
  document.getElementById('account-is-main').checked = false;
  
  document.getElementById('account-modal').classList.add('active');
}

function updateAggressivenessDisplay() {
  const minValue = parseInt(document.getElementById('strategy-aggressiveness-min').value);
  const maxValue = parseInt(document.getElementById('strategy-aggressiveness-max').value);
  
  // Ensure max is always greater than or equal to min
  if (maxValue < minValue) {
    document.getElementById('strategy-aggressiveness-max').value = minValue;
  }
  if (minValue > maxValue) {
    document.getElementById('strategy-aggressiveness-min').value = maxValue;
  }
  
  const finalMin = Math.min(minValue, maxValue);
  const finalMax = Math.max(minValue, maxValue);
  
  document.getElementById('aggressiveness-min-display').textContent = finalMin + '%';
  document.getElementById('aggressiveness-max-display').textContent = finalMax + '%';
  
  // Update range bar visualization
  const rangeBar = document.getElementById('aggressiveness-range-bar');
  rangeBar.style.left = finalMin + '%';
  rangeBar.style.width = (finalMax - finalMin) + '%';
}

function openStrategyModal() {
  editingStrategyId = null;
  document.getElementById('strategy-modal-title').textContent = 'Neue Strategie';
  
  // Clear form fields
  document.getElementById('strategy-name').value = '';
  document.getElementById('strategy-type').value = 'Sequenz';
  document.getElementById('strategy-description').value = '';
  document.getElementById('strategy-entry').value = '';
  document.getElementById('strategy-exit').value = '';
  document.getElementById('strategy-management').value = '';
  document.getElementById('strategy-aggressiveness-min').value = 25;
  document.getElementById('strategy-aggressiveness-max').value = 75;
  updateAggressivenessDisplay();
  document.getElementById('zone-green').checked = true;
  document.getElementById('zone-orange').checked = false;
  document.getElementById('zone-red').checked = false;
  document.getElementById('strategy-long-min').value = '';
  document.getElementById('strategy-long-max').value = '';
  document.getElementById('strategy-short-min').value = '';
  document.getElementById('strategy-short-max').value = '';
  document.getElementById('strategy-rrr').value = '';
  
  document.getElementById('strategy-modal').classList.add('active');
}

function openTradeModal(tradeId = null) {
  currentTradeId = tradeId;
  const modal = document.getElementById('trade-modal');
  
  // Populate account select
  const tradeAccountSelect = document.getElementById('trade-account');
  tradeAccountSelect.innerHTML = accounts.map(a => 
    `<option value="${a.id}">${a.name}</option>`
  ).join('');
  
  // Populate strategy select
  const tradeStrategySelect = document.getElementById('trade-strategy');
  tradeStrategySelect.innerHTML = '<option value="">-- Keine --</option>' +
    strategies.map(s => 
      `<option value="${s.id}">${s.name}</option>`
    ).join('');
  
  document.getElementById('entry-points-container').innerHTML = '';
  document.getElementById('exit-points-container').innerHTML = '';
  
  if (tradeId) {
    // Edit existing trade - handled by editTrade function
    const trade = trades.find(t => t.id === tradeId);
    if (trade) {
      document.getElementById('trade-id').value = trade.id;
      // Load other fields...
    }
  } else {
    // New trade - clear form and set default values
    document.getElementById('trade-id').value = getNextTradeId();
    document.getElementById('trade-account').value = accounts[0]?.id || '';
    document.getElementById('trade-instrument').value = '';
    document.getElementById('trade-currency').value = 'EUR';
    document.getElementById('trade-direction').value = 'LONG';
    document.getElementById('trade-initial-stop').value = '';
    document.getElementById('trade-status').value = 'Open';
    document.getElementById('trade-strategy').value = '';
    document.getElementById('trade-management').value = '';
    document.getElementById('trade-errors').value = '';
    addEntryPoint();
  }
  
  modal.classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function saveAccount() {
  const name = document.getElementById('account-name').value;
  const accountNumber = document.getElementById('account-number').value;
  const type = document.getElementById('account-type').value;
  const currency = document.getElementById('account-currency').value;
  const initialBalance = parseFloat(document.getElementById('account-initial-balance').value) || 10000;
  const isMain = document.getElementById('account-is-main').checked;
  
  if (!name) {
    showNotification('Bitte Namen eingeben', 'error');
    return;
  }
  
  if (isMain) {
    accounts.forEach(a => a.isMain = false);
  }
  
  if (editingAccountId) {
    // Update existing account
    const index = accounts.findIndex(a => a.id === editingAccountId);
    if (index !== -1) {
      const currentBalance = accounts[index].currentBalance;
      accounts[index] = {
        id: editingAccountId,
        name,
        accountNumber,
        type,
        currency,
        initialBalance,
        currentBalance: currentBalance, // Behalte currentBalance
        isMain: isMain
      };
    }
    editingAccountId = null;
  } else {
    // Create new account
    const newAccount = {
      id: Date.now(),
      name,
      accountNumber,
      type,
      currency,
      initialBalance,
      currentBalance: initialBalance,
      isMain: isMain || accounts.length === 0
    };
    accounts.push(newAccount);
  }
  
  mainAccount = accounts.find(a => a.isMain) || accounts[0];
  
  saveData();
  renderAccounts();
  updateAccountSelect();
  calculateBalanceLevel();
  closeModal('account-modal');
  showNotification('Account gespeichert', 'success');
}

function saveStrategy() {
  const name = document.getElementById('strategy-name').value;
  const type = document.getElementById('strategy-type').value;
  const description = document.getElementById('strategy-description').value;
  const entry = document.getElementById('strategy-entry').value;
  const exit = document.getElementById('strategy-exit').value;
  const management = document.getElementById('strategy-management').value;
  const aggressivenessMin = parseInt(document.getElementById('strategy-aggressiveness-min').value);
  const aggressivenessMax = parseInt(document.getElementById('strategy-aggressiveness-max').value);
  const zones = {
    green: document.getElementById('zone-green').checked,
    orange: document.getElementById('zone-orange').checked,
    red: document.getElementById('zone-red').checked
  };
  const longMin = parseFloat(document.getElementById('strategy-long-min').value) || null;
  const longMax = parseFloat(document.getElementById('strategy-long-max').value) || null;
  const shortMin = parseFloat(document.getElementById('strategy-short-min').value) || null;
  const shortMax = parseFloat(document.getElementById('strategy-short-max').value) || null;
  const rrr = document.getElementById('strategy-rrr').value || '1.0 - 3.0';
  
  if (!name) {
    showNotification('Bitte Namen eingeben', 'error');
    return;
  }
  
  if (editingStrategyId) {
    // Update existing strategy
    const index = strategies.findIndex(s => s.id === editingStrategyId);
    if (index !== -1) {
      strategies[index] = {
        id: editingStrategyId,
        name,
        type,
        description,
        entry,
        exit,
        management,
        aggressivenessMin,
        aggressivenessMax,
        aggressiveness: aggressivenessMin, // Keep for backward compatibility
        zones,
        longMinAdvantage: longMin,
        longMaxAdvantage: longMax,
        shortMinAdvantage: shortMin,
        shortMaxAdvantage: shortMax,
        rrr
      };
    }
    editingStrategyId = null;
  } else {
    // Create new strategy
    const newStrategy = {
      id: Date.now(),
      name,
      type,
      description,
      entry,
      exit,
      management,
      aggressivenessMin,
      aggressivenessMax,
      aggressiveness: aggressivenessMin, // Keep for backward compatibility
      zones,
      longMinAdvantage: longMin,
      longMaxAdvantage: longMax,
      shortMinAdvantage: shortMin,
      shortMaxAdvantage: shortMax,
      rrr
    };
    strategies.push(newStrategy);
  }
  
  saveData();
  renderStrategies();
  updateStrategySelect();
  suggestStrategies();
  closeModal('strategy-modal');
  showNotification('Strategie gespeichert', 'success');
}

// Helper function to get instrument details
function getInstrumentDetails(instrumentName) {
  // Default values for unknown instruments
  let tickValue = 1;
  let tickSize = 0.01;
  let isStock = false;
  
  // Define all instruments with their specifications
  const instrumentSpecs = {
    // DAX Futures
    'FDAX': { tickValue: 12.5, tickSize: 0.5, isStock: false },
    'FDXM': { tickValue: 5, tickSize: 1, isStock: false },
    'FDXS': { tickValue: 1, tickSize: 1, isStock: false },
    
    // S&P 500 Futures
    'ES': { tickValue: 12.5, tickSize: 0.25, isStock: false },
    'MES': { tickValue: 1.25, tickSize: 0.25, isStock: false },
    
    // NASDAQ Futures
    'NQ': { tickValue: 5, tickSize: 0.25, isStock: false },
    'MNQ': { tickValue: 0.5, tickSize: 0.25, isStock: false },
    
    // Dow Jones Futures
    'YM': { tickValue: 5, tickSize: 1, isStock: false },
    'MYM': { tickValue: 0.5, tickSize: 1, isStock: false },
    
    // Russell 2000 Futures
    'RTY': { tickValue: 5, tickSize: 0.1, isStock: false },
    'M2K': { tickValue: 0.5, tickSize: 0.1, isStock: false },
    
    // Euro Stoxx Futures
    'FESX': { tickValue: 10, tickSize: 1, isStock: false },
    'FESM': { tickValue: 5, tickSize: 1, isStock: false },
    'FEXM': { tickValue: 1, tickSize: 1, isStock: false },
    
    // Forex Futures
    '6E (EUR/USD)': { tickValue: 12.5, tickSize: 0.0001, isStock: false },
    'M6E (Micro EUR)': { tickValue: 1.25, tickSize: 0.0001, isStock: false },
    '6B (GBP/USD)': { tickValue: 6.25, tickSize: 0.0001, isStock: false },
    'M6B (Micro GBP)': { tickValue: 0.625, tickSize: 0.0001, isStock: false },
    '6J (USD/JPY)': { tickValue: 12.5, tickSize: 0.000001, isStock: false },
    'MJY (Micro JPY)': { tickValue: 1.25, tickSize: 0.000001, isStock: false },
    '6A (AUD/USD)': { tickValue: 10, tickSize: 0.0001, isStock: false },
    '6C (CAD/USD)': { tickValue: 10, tickSize: 0.0001, isStock: false },
    '6S (CHF/USD)': { tickValue: 12.5, tickSize: 0.0001, isStock: false },
    
    // Commodities
    'GC (Gold)': { tickValue: 10, tickSize: 0.1, isStock: false },
    'MGC (Micro Gold)': { tickValue: 1, tickSize: 0.1, isStock: false },
    'SI (Silver)': { tickValue: 5, tickSize: 0.01, isStock: false },
    'SIL (Micro Silver)': { tickValue: 0.5, tickSize: 0.01, isStock: false },
    'CL (Crude Oil)': { tickValue: 10, tickSize: 0.01, isStock: false },
    'MCL (Micro Oil)': { tickValue: 1, tickSize: 0.01, isStock: false },
    'NG (Natural Gas)': { tickValue: 10, tickSize: 0.001, isStock: false },
    'HG (Copper)': { tickValue: 12.5, tickSize: 0.0005, isStock: false },
    
    // Bonds
    'FGBL (Bund)': { tickValue: 10, tickSize: 0.01, isStock: false },
    'FGBM (Bobl)': { tickValue: 10, tickSize: 0.01, isStock: false },
    'FGBS (Schatz)': { tickValue: 10, tickSize: 0.01, isStock: false },
    'ZB (30Y T-Bond)': { tickValue: 31.25, tickSize: 0.03125, isStock: false },
    'ZN (10Y T-Note)': { tickValue: 15.625, tickSize: 0.015625, isStock: false },
    'ZF (5Y T-Note)': { tickValue: 7.8125, tickSize: 0.0078125, isStock: false },
    'ZT (2Y T-Note)': { tickValue: 7.8125, tickSize: 0.00390625, isStock: false }
  };
  
  // Check if it's a known instrument
  if (instrumentSpecs[instrumentName]) {
    return instrumentSpecs[instrumentName];
  }
  
  // Check if it's a stock (contains parentheses or known stock names)
  if (instrumentName && (instrumentName.includes('(') || instrumentName.includes(')'))) {
    return { tickValue: 1, tickSize: 0.01, isStock: true };
  }
  
  // Default to stock settings for unknown instruments
  return { tickValue: 1, tickSize: 0.01, isStock: true };
}

function saveTrade() {
  const tradeId = parseInt(document.getElementById('trade-id').value);
  const accountId = parseInt(document.getElementById('trade-account').value);
  const account = accounts.find(a => a.id === accountId);
  
  // Sammle Entry Points
  const entryPoints = [];
  const entryElements = document.querySelectorAll('#entry-points-container .entry-exit-point');
  entryElements.forEach(el => {
    const date = el.querySelector('.entry-date')?.value || '';
    const price = parseFloat(el.querySelector('.entry-price')?.value) || 0;
    const size = parseFloat(el.querySelector('.entry-size')?.value) || 0;
    if (price > 0) {
      entryPoints.push({ date, price, size });
    }
  });
  
  // Sammle Exit Points
  const exitPoints = [];
  const exitElements = document.querySelectorAll('#exit-points-container .entry-exit-point');
  exitElements.forEach(el => {
    const date = el.querySelector('.exit-date')?.value || '';
    const price = parseFloat(el.querySelector('.exit-price')?.value) || 0;
    const size = parseFloat(el.querySelector('.exit-size')?.value) || 0;
    if (price > 0) {
      exitPoints.push({ date, price, size });
    }
  });
  
  // Berechne P&L wenn Trade geschlossen
  let pl = 0;
  const status = document.getElementById('trade-status').value;
  const direction = document.getElementById('trade-direction').value;
  const instrumentName = document.getElementById('trade-instrument').value;
  
  if (status === 'Closed' && entryPoints.length > 0 && exitPoints.length > 0) {
    // Get instrument details
    const instrumentDetails = getInstrumentDetails(instrumentName);
    
    const avgEntryPrice = entryPoints.reduce((sum, e) => sum + e.price * e.size, 0) / 
                          entryPoints.reduce((sum, e) => sum + e.size, 0);
    const avgExitPrice = exitPoints.reduce((sum, e) => sum + e.price * e.size, 0) / 
                         exitPoints.reduce((sum, e) => sum + e.size, 0);
    const totalSize = Math.min(
      entryPoints.reduce((sum, e) => sum + e.size, 0),
      exitPoints.reduce((sum, e) => sum + e.size, 0)
    );
    
    // Calculate P&L based on instrument type
    if (instrumentDetails.isStock) {
      // For stocks: direct price calculation
      if (direction === 'LONG') {
        pl = (avgExitPrice - avgEntryPrice) * totalSize;
      } else {
        pl = (avgEntryPrice - avgExitPrice) * totalSize;
      }
    } else {
      // For futures/CFDs: consider tick value
      const priceDiff = direction === 'LONG' ? 
        (avgExitPrice - avgEntryPrice) : 
        (avgEntryPrice - avgExitPrice);
      
      const ticks = priceDiff / instrumentDetails.tickSize;
      pl = ticks * instrumentDetails.tickValue * totalSize;
    }
  }
  
  const trade = {
    id: tradeId,
    accountId: accountId,
    accountName: account?.name || '',
    instrument: instrumentName,
    currency: document.getElementById('trade-currency').value,
    direction: direction,
    entries: entryPoints,
    exits: exitPoints,
    initialStop: parseFloat(document.getElementById('trade-initial-stop').value) || null,
    strategyId: document.getElementById('trade-strategy').value || null,
    management: document.getElementById('trade-management').value || '',
    errors: document.getElementById('trade-errors').value || '',
    status: status,
    pl: pl,
    date: new Date().toLocaleString('de-DE')
  };
  
  if (currentTradeId) {
    const index = trades.findIndex(t => t.id === currentTradeId);
    if (index !== -1) {
      // Behalte das ursprüngliche Datum bei Updates
      trade.date = trades[index].date;
      trades[index] = trade;
    }
  } else {
    trades.push(trade);
  }
  
  saveData();
  renderTrades();
  calculateBalanceLevel();
  closeModal('trade-modal');
  showNotification('Trade gespeichert', 'success');
}

function addEntryPoint(date = '', price = '', size = '') {
  const container = document.getElementById('entry-points-container');
  const div = document.createElement('div');
  div.className = 'entry-exit-point';
  div.innerHTML = `
    <input type="datetime-local" value="${date}" class="entry-date" />
    <input type="number" placeholder="Preis" value="${price}" step="0.01" class="entry-price" />
    <input type="number" placeholder="Size" value="${size}" step="1" class="entry-size" />
    <button class="remove-btn" onclick="this.parentElement.remove()">×</button>
  `;
  container.appendChild(div);
}

function addExitPoint(date = '', price = '', size = '') {
  const container = document.getElementById('exit-points-container');
  const div = document.createElement('div');
  div.className = 'entry-exit-point';
  div.innerHTML = `
    <input type="datetime-local" value="${date}" class="exit-date" />
    <input type="number" placeholder="Preis" value="${price}" step="0.01" class="exit-price" />
    <input type="number" placeholder="Size" value="${size}" step="1" class="exit-size" />
    <button class="remove-btn" onclick="this.parentElement.remove()">×</button>
  `;
  container.appendChild(div);
}

function handleScreenshots(event) {
  // Screenshot handling logic
}

function setMainAccount(accountId) {
  accounts.forEach(a => a.isMain = false);
  const account = accounts.find(a => a.id === accountId);
  if (account) {
    account.isMain = true;
    mainAccount = account;
    saveData();
    renderAccounts();
    updateAccountSelect();
    calculateBalanceLevel();
    document.getElementById('current-account-name').textContent = account.name;
    showNotification(`${account.name} als Hauptaccount gesetzt`, 'success');
  }
}

function editAccount(id) {
  editingAccountId = id;
  const account = accounts.find(a => a.id === id);
  
  if (!account) return;
  
  // Fülle Modal mit vorhandenen Daten
  document.getElementById('account-modal-title').textContent = 'Account bearbeiten';
  document.getElementById('account-name').value = account.name;
  document.getElementById('account-number').value = account.accountNumber || '';
  document.getElementById('account-type').value = account.type;
  document.getElementById('account-currency').value = account.currency || 'EUR';
  document.getElementById('account-initial-balance').value = account.initialBalance;
  document.getElementById('account-is-main').checked = account.isMain || false;
  
  document.getElementById('account-modal').classList.add('active');
}

function deleteAccount(id) {
  if (accounts.length <= 1) {
    showNotification('Mindestens ein Account muss vorhanden sein', 'error');
    return;
  }
  
  if (confirm('Account wirklich löschen?')) {
    const account = accounts.find(a => a.id === id);
    accounts = accounts.filter(a => a.id !== id);
    
    if (account?.isMain && accounts.length > 0) {
      accounts[0].isMain = true;
      mainAccount = accounts[0];
    }
    
    saveData();
    renderAccounts();
    updateAccountSelect();
    calculateBalanceLevel();
    showNotification('Account gelöscht', 'success');
  }
}

function editStrategy(id) {
  console.log('editStrategy aufgerufen mit ID:', id);
  editingStrategyId = id;
  const strategy = strategies.find(s => s.id === id);
  
  if (!strategy) {
    console.error('Strategie nicht gefunden mit ID:', id);
    return;
  }
  console.log('Strategie gefunden:', strategy);
  
  // Fülle Modal mit vorhandenen Daten
  document.getElementById('strategy-modal-title').textContent = 'Strategie bearbeiten';
  document.getElementById('strategy-name').value = strategy.name;
  document.getElementById('strategy-type').value = strategy.type;
  document.getElementById('strategy-description').value = strategy.description || '';
  document.getElementById('strategy-entry').value = strategy.entry || '';
  document.getElementById('strategy-exit').value = strategy.exit || '';
  document.getElementById('strategy-management').value = strategy.management || '';
  
  // Handle both old single value and new range format
  if (strategy.aggressivenessMin !== undefined && strategy.aggressivenessMax !== undefined) {
    document.getElementById('strategy-aggressiveness-min').value = strategy.aggressivenessMin;
    document.getElementById('strategy-aggressiveness-max').value = strategy.aggressivenessMax;
  } else {
    // Backward compatibility with old single value
    const singleValue = strategy.aggressiveness || 50;
    document.getElementById('strategy-aggressiveness-min').value = Math.max(0, singleValue - 25);
    document.getElementById('strategy-aggressiveness-max').value = Math.min(100, singleValue + 25);
  }
  updateAggressivenessDisplay();
  
  // Setze Kontozonen
  if (strategy.zones) {
    document.getElementById('zone-green').checked = strategy.zones.green || false;
    document.getElementById('zone-orange').checked = strategy.zones.orange || false;
    document.getElementById('zone-red').checked = strategy.zones.red || false;
  } else {
    document.getElementById('zone-green').checked = true;
    document.getElementById('zone-orange').checked = false;
    document.getElementById('zone-red').checked = false;
  }
  
  document.getElementById('strategy-long-min').value = strategy.longMinAdvantage || '';
  document.getElementById('strategy-long-max').value = strategy.longMaxAdvantage || '';
  document.getElementById('strategy-short-min').value = strategy.shortMinAdvantage || '';
  document.getElementById('strategy-short-max').value = strategy.shortMaxAdvantage || '';
  document.getElementById('strategy-rrr').value = strategy.rrr || '';
  
  document.getElementById('strategy-modal').classList.add('active');
}

function deleteStrategy(id) {
  console.log('deleteStrategy aufgerufen mit ID:', id);
  if (confirm('Strategie wirklich löschen?')) {
    strategies = strategies.filter(s => s.id !== id);
    saveData();
    renderStrategies();
    updateStrategySelect();
    suggestStrategies();
    showNotification('Strategie gelöscht', 'success');
  }
}

function editTrade(id) {
  currentTradeId = parseInt(id);
  const trade = trades.find(t => t.id === currentTradeId);
  
  if (!trade) return;
  
  const modal = document.getElementById('trade-modal');
  
  // Populate account select first
  const tradeAccountSelect = document.getElementById('trade-account');
  tradeAccountSelect.innerHTML = accounts.map(a => 
    `<option value="${a.id}">${a.name}</option>`
  ).join('');
  
  // Populate strategy select
  const tradeStrategySelect = document.getElementById('trade-strategy');
  tradeStrategySelect.innerHTML = '<option value="">-- Keine --</option>' +
    strategies.map(s => 
      `<option value="${s.id}">${s.name}</option>`
    ).join('');
  
  // Load trade data into form
  document.getElementById('trade-id').value = trade.id;
  document.getElementById('trade-account').value = trade.accountId || '';
  document.getElementById('trade-instrument').value = trade.instrument || '';
  document.getElementById('trade-currency').value = trade.currency || 'EUR';
  document.getElementById('trade-direction').value = trade.direction || 'LONG';
  document.getElementById('trade-initial-stop').value = trade.initialStop || '';
  document.getElementById('trade-status').value = trade.status || 'Open';
  document.getElementById('trade-strategy').value = trade.strategyId || '';
  document.getElementById('trade-management').value = trade.management || '';
  document.getElementById('trade-errors').value = trade.errors || '';
  
  // Clear and populate entry points
  const entryContainer = document.getElementById('entry-points-container');
  entryContainer.innerHTML = '';
  if (trade.entries && trade.entries.length > 0) {
    trade.entries.forEach(entry => {
      addEntryPoint(entry.date || '', entry.price || '', entry.size || 1);
    });
  } else {
    addEntryPoint();
  }
  
  // Clear and populate exit points
  const exitContainer = document.getElementById('exit-points-container');
  exitContainer.innerHTML = '';
  if (trade.exits && trade.exits.length > 0) {
    trade.exits.forEach(exit => {
      addExitPoint(exit.date || '', exit.price || '', exit.size || 1);
    });
  }
  
  modal.classList.add('active');
}

function deleteTrade(id) {
  if (confirm('Trade wirklich löschen?')) {
    trades = trades.filter(t => t.id !== parseInt(id));
    saveData();
    renderTrades();
    calculateBalanceLevel();
    showNotification('Trade gelöscht', 'success');
  }
}

function exportTrades() {
  let csv = 'ID,Account,Instrument,Currency,Direction,Size,Entries,Exits,Initial Stop,P&L,Status\n';
  trades.forEach(trade => {
    const totalSize = trade.entries && trade.entries.length > 0 
      ? trade.entries.reduce((sum, entry) => sum + (entry.size || 0), 0)
      : 0;
    const entries = trade.entries ? trade.entries.map(e => `${e.price}@${e.size || 0}`).join(';') : '';
    const exits = trade.exits ? trade.exits.map(e => `${e.price}@${e.size || 0}`).join(';') : '';
    csv += `"${trade.id}","${trade.accountName}","${trade.instrument}","${trade.currency}","${trade.direction}","${totalSize}","${entries}","${exits}","${trade.initialStop || ''}","${trade.pl}","${trade.status}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  
  showNotification('Trades exportiert', 'success');
}

function init() {
  loadData();
  initializeTradeId();
  updateMAInstruments();
  updateInstruments();
  calculateAll();
  renderAccounts();
  renderStrategies();
  renderTrades();
  renderTransactionHistory(); // Render transaction history
  updateAccountSelect();
  updateStrategySelect();
  updateDashboard();
  
  // Korrekte Anzeige des Hauptaccounts im Header
  if (mainAccount) {
    document.getElementById('current-account-name').textContent = mainAccount.name;
    document.getElementById('account-select').value = mainAccount.id;
    updateAccountBalance();
  }
}

// Transaction Modal Functions
function openTransactionModal(type = 'deposit') {
  const modal = document.getElementById('transaction-modal');
  const title = document.getElementById('transaction-modal-title');
  const typeSelect = document.getElementById('transaction-type');
  
  // Set title and type
  title.textContent = type === 'deposit' ? '💰 Einzahlung' : '💸 Auszahlung';
  typeSelect.value = type;
  
  // Populate account select
  const accountSelect = document.getElementById('transaction-account');
  accountSelect.innerHTML = accounts.map(a => 
    `<option value="${a.id}">${a.name} - ${a.currency} ${a.currentBalance.toLocaleString('de-DE')}</option>`
  ).join('');
  
  // Set initial values
  document.getElementById('transaction-amount').value = '';
  document.getElementById('transaction-description').value = '';
  
  // Update balance preview
  updateTransactionPreview();
  
  // Add event listeners
  document.getElementById('transaction-account').onchange = updateTransactionPreview;
  document.getElementById('transaction-type').onchange = updateTransactionPreview;
  document.getElementById('transaction-amount').oninput = updateTransactionPreview;
  
  modal.classList.add('active');
}

function updateTransactionPreview() {
  const accountId = parseInt(document.getElementById('transaction-account').value);
  const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;
  const type = document.getElementById('transaction-type').value;
  
  const account = accounts.find(a => a.id === accountId);
  if (!account) return;
  
  const currentBalance = account.currentBalance;
  const newBalance = type === 'deposit' ? 
    currentBalance + amount : 
    currentBalance - amount;
  
  document.getElementById('transaction-current-balance').textContent = 
    `${account.currency} ${currentBalance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  
  const newBalanceElement = document.getElementById('transaction-new-balance');
  newBalanceElement.textContent = 
    `${account.currency} ${newBalance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  
  // Color coding
  if (type === 'withdrawal' && newBalance < 0) {
    newBalanceElement.style.color = '#ef4444';
  } else if (type === 'deposit') {
    newBalanceElement.style.color = '#10b981';
  } else {
    newBalanceElement.style.color = '#e2e8f0';
  }
}

function executeTransaction() {
  const accountId = parseInt(document.getElementById('transaction-account').value);
  const amount = parseFloat(document.getElementById('transaction-amount').value);
  const type = document.getElementById('transaction-type').value;
  const description = document.getElementById('transaction-description').value;
  
  if (!amount || amount <= 0) {
    showNotification('Bitte gültigen Betrag eingeben', 'error');
    return;
  }
  
  if (processTransaction(accountId, amount, type, description)) {
    closeModal('transaction-modal');
    renderAccounts();
    renderTransactionHistory();
    calculateBalanceLevel();
  }
}

function renderTransactionHistory() {
  const tbody = document.getElementById('transaction-history-body');
  if (!tbody) return;
  
  const sortedTransactions = [...transactions].sort((a, b) => {
    const dateA = new Date(a.date || 0);
    const dateB = new Date(b.date || 0);
    return dateB - dateA;
  });
  
  if (sortedTransactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">Keine Transaktionen vorhanden</td></tr>';
    return;
  }
  
  tbody.innerHTML = sortedTransactions.slice(0, 10).map(transaction => {
    const typeColor = transaction.type === 'deposit' ? '#10b981' : '#ef4444';
    const typeText = transaction.type === 'deposit' ? '⬆️ Einzahlung' : '⬇️ Auszahlung';
    const amountColor = transaction.type === 'deposit' ? '#10b981' : '#ef4444';
    
    return `
      <tr>
        <td style="font-size: 11px;">${transaction.date}</td>
        <td>${transaction.accountName}</td>
        <td style="color: ${typeColor};">${typeText}</td>
        <td style="color: ${amountColor}; font-weight: 600;">
          ${transaction.type === 'deposit' ? '+' : '-'}${transaction.currency} ${transaction.amount.toLocaleString('de-DE', { minimumFractionDigits: 2 })}
        </td>
        <td style="font-size: 11px;">${transaction.description || '-'}</td>
        <td>${transaction.currency} ${transaction.balanceAfter.toLocaleString('de-DE', { minimumFractionDigits: 2 })}</td>
        <td>
          <button class="delete-btn" onclick="deleteTransactionAndRefresh(${transaction.id})" style="padding: 2px 6px; font-size: 10px;">×</button>
        </td>
      </tr>
    `;
  }).join('');
}

function deleteTransactionAndRefresh(transactionId) {
  if (confirm('Transaktion wirklich löschen?')) {
    if (deleteTransaction(transactionId)) {
      renderAccounts();
      renderTransactionHistory();
      calculateBalanceLevel();
    }
  }
}

// Mobile Menu Functionality
function initializeMobileMenu() {
  const menuToggle = document.getElementById('mobile-menu-toggle');
  const tabBar = document.getElementById('tab-bar');
  const overlay = document.getElementById('mobile-overlay');
  
  if (menuToggle) {
    menuToggle.addEventListener('click', function() {
      tabBar.classList.toggle('mobile-open');
      overlay.classList.toggle('active');
    });
  }
  
  if (overlay) {
    overlay.addEventListener('click', function() {
      tabBar.classList.remove('mobile-open');
      overlay.classList.remove('active');
    });
  }
  
  // Close mobile menu when a tab is clicked
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        tabBar.classList.remove('mobile-open');
        overlay.classList.remove('active');
      }
    });
  });
  
  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
      tabBar.classList.remove('mobile-open');
      overlay.classList.remove('active');
    }
  });
}

// Initialize everything when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    init();
    initializeMobileMenu();
  });
} else {
  init();
  initializeMobileMenu();
}
  </script>
  <div class="app-wrapper">
  <div class="header-bar">
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Menu">
      ☰
    </button>
    <div class="header-title">
      <div class="logo">
        <svg viewBox="0 0 220 50" style="height: 100%; width: auto;">
          <!-- TraceVizion Logo mit offiziellen Brand-Farben -->
          <defs>
            <linearGradient id="tvGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#00CFC8;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#00A09A;stop-opacity:1" />
            </linearGradient>
          </defs>
          
          <!-- Logo Symbol - Geometrischer Vogel/Origami-Stil -->
          <g transform="translate(8,10)">
            <!-- Hauptform - stilisierter Vogel aus Dreiecken -->
            <!-- Körper/Flügel -->
            <path d="M 0,20 L 15,5 L 25,15 L 15,30 Z" fill="#00CFC8" opacity="1"/>
            <!-- Kopf/oberer Teil -->
            <path d="M 15,5 L 25,0 L 30,10 L 25,15 Z" fill="#00CFC8" opacity="0.85"/>
            <!-- Schwanz/unterer Teil -->
            <path d="M 15,30 L 25,15 L 30,25 L 20,35 Z" fill="#00CFC8" opacity="0.7"/>
            <!-- Akzent-Dreieck für Tiefe -->
            <path d="M 10,15 L 20,10 L 22,20 Z" fill="#00A09A" opacity="0.5"/>
          </g>
          
          <!-- TRACEVIZION Text -->
          <text x="45" y="32" font-family="'Arial', 'Helvetica', sans-serif" font-size="18" font-weight="bold" fill="#00CFC8" letter-spacing="1">TRACEVIZION</text>
        </svg>
      </div>
      <span>TraceVizion Pro</span>
    </div>
    <div class="header-actions">
      <div class="account-info">
        <span>Account: <span id="current-account-name">Papertrading</span></span>
        <span class="balance neutral" id="header-balance">EUR 10,000 (0%)</span>
      </div>
      <button class="save-button" onclick="saveAnalysisToDashboard()">💾 Save Analysis</button>
    </div>
  </div>
  
  <!-- Mobile Menu Overlay -->
  <div class="mobile-overlay" id="mobile-overlay"></div>
  
  <div class="tab-bar" id="tab-bar">
    <button class="tab active" onclick="switchModule('dashboard', event)">Dashboard</button>
    <button class="tab" onclick="switchModule('market', event)">Marktanalyse</button>
    <button class="tab" onclick="switchModule('accounts', event)">Accounts</button>
    <button class="tab" onclick="switchModule('strategies', event)">Strategien</button>
    <button class="tab" onclick="switchModule('tradelog', event)">Trade Log</button>
    <button class="tab" onclick="switchModule('reports', event)">Reports</button>
  </div>
  
  <!-- Dashboard Module -->
  <div id="dashboard-module" class="module active">
    <div class="dashboard">
      <div class="panel" style="grid-column: 1 / -1;">
        <h2 class="panel-title">Trading Dashboard - Letzte Analysen</h2>
        <div id="dashboard-analyses" style="display: grid; gap: 12px;">
          <!-- Will be populated with recent analyses -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Market Analysis Module -->
  <div id="market-module" class="module">
    <div class="dashboard">
      <!-- Left Panel: Market Analysis -->
      <div class="panel">
        <h2 class="panel-title">Market Analysis</h2>
        
        <div class="section-title">Market & Instrument</div>
        <div class="form-row">
          <label class="form-label">Market</label>
          <select class="form-select" id="ma-market-select" onchange="updateMAInstruments()">
            <option value="dax">DAX</option>
            <option value="sp500">S&P 500</option>
            <option value="nasdaq">NASDAQ</option>
            <option value="dow">Dow Jones</option>
            <option value="russell">Russell 2000</option>
            <option value="eurostoxx">Euro Stoxx 50</option>
            <option value="forex">Forex Futures</option>
            <option value="commodities">Rohstoffe</option>
            <option value="bonds">Anleihen</option>
            <option value="stocks-dax">Aktien DAX</option>
            <option value="stocks-sp500">Aktien S&P 500</option>
            <option value="stocks-nasdaq">Aktien NASDAQ</option>
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Instrument</label>
          <select class="form-select" id="ma-instrument-select" onchange="syncInstrumentToRisk()">
            <!-- Will be populated dynamically -->
          </select>
        </div>
        
        <div class="section-title">Time Level & Progression</div>
        <div class="trend-row">
          <span class="trend-label daily">Daily</span>
          <select class="trend-select" id="trend-daily" onchange="calculateAll()">
            <option value="1">↑ Trendy Long</option>
            <option value="0.5">↗ Choppy Long</option>
            <option value="0" selected>→ Sideways</option>
            <option value="-0.5">↘ Choppy Short</option>
            <option value="-1">↓ Trendy Short</option>
          </select>
          <span class="trend-weight">20%</span>
        </div>
        
        <div class="trend-row">
          <span class="trend-label hourly">Hourly</span>
          <select class="trend-select" id="trend-hourly" onchange="calculateAll()">
            <option value="1">↑ Trendy Long</option>
            <option value="0.5">↗ Choppy Long</option>
            <option value="0" selected">→ Sideways</option>
            <option value="-0.5">↘ Choppy Short</option>
            <option value="-1">↓ Trendy Short</option>
          </select>
          <span class="trend-weight">70%</span>
        </div>
        
        <div class="trend-row">
          <span class="trend-label minute">15min</span>
          <select class="trend-select" id="trend-minute" onchange="calculateAll()">
            <option value="1">↑ Trendy Long</option>
            <option value="0.5">↗ Choppy Long</option>
            <option value="0" selected>→ Sideways</option>
            <option value="-0.5">↘ Choppy Short</option>
            <option value="-1">↓ Trendy Short</option>
          </select>
          <span class="trend-weight">10%</span>
        </div>
        
        <div class="section-title">Elliott Waves</div>
        <div class="form-row">
          <label class="form-label">Wave Pattern</label>
          <select class="form-select" id="elliott-wave" onchange="calculateAll()">
            <option value="Wave 1">Wave 1 (Anfang)</option>
            <option value="Wave 2">Wave 2 (Korrektur)</option>
            <option value="Wave 3 (strongest)">Wave 3 (Stärkste)</option>
            <option value="Wave 4">Wave 4 (Korrektur)</option>
            <option value="Wave 5 (final)">Wave 5 (Finale)</option>
            <option value="Corrective wave">Corrective ABC</option>
            <option value="Impulse wave" selected>Impulse Wave</option>
          </select>
        </div>
        
        <div class="gauge-grid">
          <!-- Vorteil Level - Elegant Style -->
          <div class="metric-card vorteil-card">
            <div class="vorteil-header">
              <span class="vorteil-title">VORTEIL ANALYSE</span>
            </div>
            <div class="vorteil-display">
              <div class="vorteil-percentage" id="benefit-value">0%</div>
              <div class="vorteil-signal" id="benefit-signal">
                <span id="benefit-label">NEUTRAL</span>
              </div>
            </div>
            <div class="vorteil-bar-wrapper">
              <div class="vorteil-bar-container">
                <div class="vorteil-bar-segment short"></div>
                <div class="vorteil-bar-segment neutral"></div>
                <div class="vorteil-bar-segment long"></div>
                <div class="vorteil-bar-indicator" id="benefit-indicator"></div>
              </div>
              <div class="vorteil-scale">
                <span>-100</span>
                <span>-33</span>
                <span>0</span>
                <span>33</span>
                <span>100</span>
              </div>
            </div>
          </div>
          
          <!-- Balance Level - Modern Card Style -->
          <div class="metric-card">
            <div class="metric-header">
              <span class="metric-label">BALANCE LEVEL</span>
              <span class="metric-icon">💰</span>
            </div>
            <div class="metric-value-container">
              <div class="metric-main-value" id="market-value">100%</div>
              <div class="metric-sub-label" id="market-label">Baseline</div>
            </div>
            <div class="metric-circular-progress">
              <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                <circle cx="50" cy="50" r="45" stroke="rgba(30, 41, 59, 0.3)" stroke-width="8" fill="none"/>
                <circle id="market-circle" cx="50" cy="50" r="45" stroke="#f59e0b" stroke-width="8" fill="none"
                        stroke-dasharray="283" stroke-dashoffset="141" stroke-linecap="round"
                        transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);"/>
            </svg>
            </div>
          </div>
          
          <!-- Risk Level - Modern Card Style -->
          <div class="metric-card">
            <div class="metric-header">
              <span class="metric-label">RISK LEVEL</span>
              <span class="metric-icon">🎯</span>
            </div>
            <div class="metric-value-container">
              <div class="metric-main-value" id="risk-level-value">50%</div>
              <div class="metric-sub-label" id="risk-label">Moderat</div>
            </div>
            <div class="risk-indicator-container">
              <div class="risk-indicator risk-low" id="risk-low">
                <span>LOW</span>
              </div>
              <div class="risk-indicator risk-medium active" id="risk-medium">
                <span>MED</span>
              </div>
              <div class="risk-indicator risk-high" id="risk-high">
                <span>HIGH</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="strategy-suggestions" id="strategy-suggestions" style="display: block;">
          <div class="suggestion-title">🎯 Empfohlene Strategien</div>
          <div class="suggestion-list" id="suggested-strategies">
            <span style="color: #64748b; font-size: 12px;">
              Wähle Trend-Einstellungen für Strategievorschläge
            </span>
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(16, 185, 129, 0.2);">
            <div style="font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
              Strategiebereiche:
            </div>
            <div style="font-size: 11px; color: #94a3b8; line-height: 1.6;">
              <div>📈 <strong>Long:</strong> +33% bis +100% (SQ), +50% bis +100% (BOR)</div>
              <div>📉 <strong>Short:</strong> -33% bis -100% (SQ), -50% bis -100% (BOR)</div>
              <div>📊 <strong>Gap:</strong> -20% bis +100% (Long), +20% bis -100% (Short)</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Middle Panel: Gear System -->
      <div class="panel">
        <h2 class="panel-title">Gear System</h2>
        
        <div class="gear-display" id="gear-display">
          <div class="gear-suggestion" id="gear-suggestion">Empfohlen: Gear 3</div>
          <div class="gear-number" id="gear-number">3</div>
          <div class="gear-selector">
            <button class="gear-btn" onclick="setGear(1)" id="gear-1">1</button>
            <button class="gear-btn" onclick="setGear(2)" id="gear-2">2</button>
            <button class="gear-btn active suggested" onclick="setGear(3)" id="gear-3">3</button>
            <button class="gear-btn" onclick="setGear(4)" id="gear-4">4</button>
            <button class="gear-btn" onclick="setGear(5)" id="gear-5">5</button>
          </div>
        </div>
        
        <!-- 10-Day Equity Curve Mini Chart -->
        <div style="background: #1e293b; border-radius: 8px; padding: 12px; margin-top: 16px;">
          <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
            10-Tage Equity Curve
          </div>
          <div style="position: relative; height: 80px;">
            <canvas id="mini-equity-chart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
        
        <div class="section-title">Strategy Selection</div>
        <div class="form-row">
          <label class="form-label">Active</label>
          <select class="form-select" id="active-strategy">
            <option value="">-- Wähle Strategie --</option>
          </select>
        </div>
        
        <div class="section-title">Strategy Details</div>
        <div id="strategy-detail-display">
          <p style="text-align: center; color: #64748b; padding: 20px;">
            Wähle eine Strategie aus den Empfehlungen oder manuell
          </p>
        </div>
      </div>
      
      <!-- Right Panel: Risk & Trade Planning -->
      <div class="panel">
        <h2 class="panel-title">Risk & Trade Planning</h2>
        
        <div class="section-title">Selected Account</div>
        <div class="form-row">
          <label class="form-label">Account</label>
          <select class="form-select" id="account-select" onchange="updateAccountBalance()">
            <!-- Will be populated dynamically -->
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Balance</label>
          <input type="number" class="form-input" id="account-balance" value="10000" readonly />
        </div>
        
        <div class="section-title">Risk Class</div>
        <div class="risk-selector">
          <button class="risk-btn" onclick="setRisk(0.5)" id="risk-05">
            <div class="risk-title">Konservativ</div>
            <div class="risk-percent">0.5%</div>
          </button>
          <button class="risk-btn active" onclick="setRisk(1)" id="risk-1">
            <div class="risk-title">Standard</div>
            <div class="risk-percent">1.0%</div>
          </button>
          <button class="risk-btn" onclick="setRisk(2)" id="risk-2">
            <div class="risk-title">Aggressiv</div>
            <div class="risk-percent">2.0%</div>
          </button>
        </div>
        
        <div class="form-row">
          <label class="form-label">Risk Amount</label>
          <input type="text" class="form-input" id="risk-amount" value="EUR 100" readonly />
        </div>
        
        <div class="section-title">Trade Setup</div>
        <div class="form-row">
          <label class="form-label">Market</label>
          <select class="form-select" id="market-select" onchange="updateInstruments()">
            <option value="dax">DAX</option>
            <option value="sp500">S&P 500</option>
            <option value="nasdaq">NASDAQ</option>
            <option value="dow">Dow Jones</option>
            <option value="russell">Russell 2000</option>
            <option value="eurostoxx">Euro Stoxx 50</option>
            <option value="forex">Forex Futures</option>
            <option value="commodities">Rohstoffe</option>
            <option value="bonds">Anleihen</option>
            <option value="stocks-dax">Aktien DAX</option>
            <option value="stocks-sp500">Aktien S&P 500</option>
            <option value="stocks-nasdaq">Aktien NASDAQ</option>
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Instrument</label>
          <select class="form-select" id="instrument-select" onchange="calculatePosition()">
            <!-- Will be populated dynamically -->
          </select>
        </div>
        
        <div class="trade-box">
          <div class="trade-row">
            <div class="trade-item">
              <span class="trade-label">Entry</span>
              <input type="number" class="trade-value" id="entry-price" value="21454" step="0.01" onchange="calculatePosition()" />
            </div>
            <div class="trade-item">
              <span class="trade-label">Stop Loss</span>
              <input type="number" class="trade-value loss" id="stop-price" value="21337" step="0.01" onchange="calculatePosition()" />
            </div>
          </div>
          
          <div class="trade-row">
            <div class="trade-item">
              <span class="trade-label">Target</span>
              <input type="number" class="trade-value profit" id="target-price" value="21700" step="0.01" onchange="calculatePosition()" />
            </div>
            <div class="trade-item">
              <span class="trade-label">RRR</span>
              <div class="trade-value" id="rrr-value">2.10</div>
            </div>
          </div>
        </div>
        
        <div class="crv-display">
          <div class="crv-value crv-good" id="crv-display">CRV: 2.10</div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Risk €</div>
            <div class="stat-value" style="color: #ef4444;">
              €<span id="risk-euros">100</span>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Reward €</div>
            <div class="stat-value" style="color: #10b981;">
              €<span id="reward-euros">210</span>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="action-button buy" id="action-btn" onclick="executeAction()">
            <span id="action-text">BUY</span>: <span id="position-size">1</span>
          </button>
          <button class="action-button add" onclick="addToTradeLog()">
            + LOG
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End of Market Module -->
  
  <!-- Accounts Module -->
  <div id="accounts-module" class="module">
    <button class="add-button" onclick="openAccountModal()">+ Neues Account hinzufügen</button>
    <button class="add-button" style="background: linear-gradient(135deg, #10b981, #34d399); margin-left: 10px;" onclick="openTransactionModal('deposit')">💰 Einzahlung</button>
    <button class="add-button" style="background: linear-gradient(135deg, #ef4444, #f87171); margin-left: 10px;" onclick="openTransactionModal('withdrawal')">💸 Auszahlung</button>
    
    <!-- Transaction History Summary -->
    <div class="panel" style="margin-top: 20px;">
      <h2 class="panel-title">Transaktionsübersicht</h2>
      <div class="table-container" style="max-height: 200px; overflow-y: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Account</th>
              <th>Typ</th>
              <th>Betrag</th>
              <th>Beschreibung</th>
              <th>Balance danach</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="transaction-history-body">
            <!-- Will be populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div id="accounts-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
      <!-- Will be populated dynamically -->
    </div>
  </div>
  
  <!-- Strategies Module -->
  <div id="strategies-module" class="module">
    <button class="add-button" onclick="openStrategyModal()">+ Neue Strategie hinzufügen</button>
    <div id="strategies-list" style="display: grid; gap: 12px;">
      <!-- Will be populated dynamically -->
    </div>
  </div>
  
  <!-- Trade Log Module -->
  <div id="tradelog-module" class="module">
    <div style="margin-bottom: 20px;">
      <button class="add-button" onclick="openTradeModal()">+ Neuen Trade hinzufügen</button>
      <button class="save-button" style="margin-left: 10px;" onclick="exportTrades()">📥 Export CSV</button>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Account</th>
            <th>Instrument</th>
            <th>Währung</th>
            <th>Richtung</th>
            <th>Größe</th>
            <th>Einstiege</th>
            <th>Ausstiege</th>
            <th>Initial Stop</th>
            <th>P&L</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="trade-log-body">
          <!-- Will be populated dynamically -->
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Reports Module -->
  <div id="reports-module" class="module">
    <div class="dashboard" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
      <!-- Main Performance Overview -->
      <div class="panel">
        <h2 class="panel-title">Performance Übersicht</h2>
        
        <!-- Primary Metrics -->
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
          <div class="stat-box">
            <div class="stat-label">Gesamt P&L</div>
            <div class="stat-value" id="report-total-pl">€0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="report-win-rate">0%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø Gewinn</div>
            <div class="stat-value" style="color: #10b981;" id="report-avg-win">€0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø Verlust</div>
            <div class="stat-value" style="color: #ef4444;" id="report-avg-loss">€0</div>
          </div>
        </div>
        
        <!-- Extended Metrics -->
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
          <div class="stat-box">
            <div class="stat-label">Profit Factor</div>
            <div class="stat-value" id="report-profit-factor">0.00</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Payoff Ratio</div>
            <div class="stat-value" id="report-payoff-ratio">0.00</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Max Drawdown</div>
            <div class="stat-value" style="color: #ef4444;" id="report-max-drawdown">€0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Erwartungswert</div>
            <div class="stat-value" id="report-expectancy">€0</div>
          </div>
        </div>
        
        <!-- Trade Statistics -->
        <div class="stats-grid" style="grid-template-columns: repeat(6, 1fr);">
          <div class="stat-box">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="report-total-trades">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Gewinner</div>
            <div class="stat-value" style="color: #10b981;" id="report-winners">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Verlierer</div>
            <div class="stat-value" style="color: #ef4444;" id="report-losers">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Breakeven</div>
            <div class="stat-value" style="color: #94a3b8;" id="report-breakeven">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Max Consec Win</div>
            <div class="stat-value" style="color: #10b981;" id="report-max-consec-win">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Max Consec Loss</div>
            <div class="stat-value" style="color: #ef4444;" id="report-max-consec-loss">0</div>
          </div>
        </div>
      </div>
      
      <!-- Equity Curve Chart -->
      <div class="panel">
        <h2 class="panel-title">Equity Curve</h2>
        <div style="position: relative; height: 300px;">
          <canvas id="equity-chart"></canvas>
        </div>
      </div>
      
      <!-- P&L Distribution -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="panel">
          <h2 class="panel-title">P&L Verteilung</h2>
          <div style="position: relative; height: 250px;">
            <canvas id="pl-distribution-chart"></canvas>
          </div>
        </div>
        
        <div class="panel">
          <h2 class="panel-title">Win/Loss Verhältnis</h2>
          <div style="position: relative; height: 250px;">
            <canvas id="win-loss-pie-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Monthly Performance Table -->
      <div class="panel">
        <h2 class="panel-title">Monatsübersicht</h2>
        <div class="table-container">
          <table class="data-table" id="monthly-performance-table">
            <thead>
              <tr>
                <th>Monat</th>
                <th>Trades</th>
                <th>Gewinner</th>
                <th>Verlierer</th>
                <th>Win Rate</th>
                <th>Brutto P&L</th>
                <th>Netto P&L</th>
                <th>Ø Trade</th>
                <th>Max DD</th>
              </tr>
            </thead>
            <tbody id="monthly-performance-body">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Best and Worst Trades -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="panel">
          <h2 class="panel-title">Top 5 Gewinner</h2>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Instrument</th>
                  <th>P&L</th>
                  <th>RRR</th>
                </tr>
              </thead>
              <tbody id="best-trades-body">
                <!-- Will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="panel">
          <h2 class="panel-title">Top 5 Verlierer</h2>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Instrument</th>
                  <th>P&L</th>
                  <th>RRR</th>
                </tr>
              </thead>
              <tbody id="worst-trades-body">
                <!-- Will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Strategy Performance -->
      <div class="panel">
        <h2 class="panel-title">Strategie Performance</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Strategie</th>
                <th>Trades</th>
                <th>Win Rate</th>
                <th>Ø Gewinn</th>
                <th>Ø Verlust</th>
                <th>Total P&L</th>
                <th>Profit Factor</th>
              </tr>
            </thead>
            <tbody id="strategy-performance-body">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Instrument Performance -->
      <div class="panel">
        <h2 class="panel-title">Instrument Performance</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>Trades</th>
                <th>Win Rate</th>
                <th>Ø P&L</th>
                <th>Total P&L</th>
                <th>Bester Trade</th>
                <th>Schlechtester Trade</th>
              </tr>
            </thead>
            <tbody id="instrument-performance-body">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Account Modal -->
  <div class="modal" id="account-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="account-modal-title">Neues Account</h2>
        <button class="modal-close" onclick="closeModal('account-modal')">×</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label class="form-label">Bezeichnung</label>
          <input type="text" class="form-input" id="account-name" placeholder="z.B. Live Trading" />
        </div>
        <div class="form-row">
          <label class="form-label">Konto-Nr.</label>
          <input type="text" class="form-input" id="account-number" placeholder="z.B. 123456789" />
        </div>
        <div class="form-row">
          <label class="form-label">Typ</label>
          <select class="form-select" id="account-type">
            <option>Paper</option>
            <option>Demo</option>
            <option>Live</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Währung</label>
          <select class="form-select" id="account-currency">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
            <option value="JPY">JPY</option>
            <option value="CHF">CHF</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Anfangsbalance</label>
          <input type="number" class="form-input" id="account-initial-balance" placeholder="10000" />
        </div>
        <div class="form-row">
          <label class="form-label">Hauptaccount</label>
          <input type="checkbox" id="account-is-main" style="width: auto;" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="save-button" onclick="saveAccount()">Speichern</button>
      </div>
    </div>
  </div>
  
  <!-- Strategy Modal -->
  <div class="modal" id="strategy-modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title" id="strategy-modal-title">Neue Strategie</h2>
        <button class="modal-close" onclick="closeModal('strategy-modal')">×</button>
      </div>
      <div class="modal-body">
        <div class="section-title">Basis Information</div>
        <div class="form-row">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="strategy-name" placeholder="z.B. SQ Advanced" />
        </div>
        <div class="form-row">
          <label class="form-label">Typ</label>
          <select class="form-select" id="strategy-type">
            <option>Sequenz</option>
            <option>Breakout</option>
            <option>Gap</option>
            <option>News</option>
            <option>Reversal</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Beschreibung</label>
          <textarea class="form-input" id="strategy-description" rows="3" 
                    placeholder="Beschreibe die Strategie und ihre Anwendungsfälle"></textarea>
        </div>
        
        <div class="section-title" style="margin-top: 16px;">Trading Details</div>
        <div class="form-row">
          <label class="form-label">Einstieg</label>
          <textarea class="form-input" id="strategy-entry" rows="2" 
                    placeholder="z.B. Bei Breakout über Resistance mit Volume"></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">Ausstieg</label>
          <textarea class="form-input" id="strategy-exit" rows="2" 
                    placeholder="z.B. Target: 2R, Stop: Unter letztem Swing Low"></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">Management</label>
          <textarea class="form-input" id="strategy-management" rows="2" 
                    placeholder="z.B. Trail Stop nach 1R, Partial bei 1.5R"></textarea>
        </div>
        
        <div class="section-title" style="margin-top: 16px;">Aggressivität & Risk</div>
        <div class="form-row">
          <label class="form-label">Aggressivität</label>
          <div>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 11px; color: #64748b; width: 35px;">Min:</span>
              <input type="range" id="strategy-aggressiveness-min" min="0" max="100" value="25" 
                     style="flex: 1;" onchange="updateAggressivenessDisplay()" />
              <span id="aggressiveness-min-display" style="width: 45px; text-align: center; 
                    padding: 4px 8px; background: #1e293b; border-radius: 4px; font-size: 12px;">25%</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <span style="font-size: 11px; color: #64748b; width: 35px;">Max:</span>
              <input type="range" id="strategy-aggressiveness-max" min="0" max="100" value="75" 
                     style="flex: 1;" onchange="updateAggressivenessDisplay()" />
              <span id="aggressiveness-max-display" style="width: 45px; text-align: center; 
                    padding: 4px 8px; background: #1e293b; border-radius: 4px; font-size: 12px;">75%</span>
            </div>
            <div style="margin-top: 8px; padding: 8px; background: #1e293b; border-radius: 6px;">
              <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Bereich:</div>
              <div style="background: #0a0e1a; height: 10px; border-radius: 5px; position: relative;">
                <div id="aggressiveness-range-bar" style="position: absolute; height: 100%; 
                     background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444); border-radius: 5px;
                     left: 25%; width: 50%;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                <span style="font-size: 10px; color: #10b981;">0% Konservativ</span>
                <span style="font-size: 10px; color: #f59e0b;">50% Moderat</span>
                <span style="font-size: 10px; color: #ef4444;">100% Aggressiv</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="section-title" style="margin-top: 16px;">Kontozonen (Drawdown-basiert)</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); 
                        border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="zone-green" style="margin-right: 8px;" />
            <div>
              <div style="font-size: 11px; font-weight: 600; color: #10b981;">Grüne Zone</div>
              <div style="font-size: 10px; color: #64748b;">0% bis -10%</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; padding: 8px; background: rgba(245, 158, 11, 0.1); 
                        border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="zone-orange" style="margin-right: 8px;" />
            <div>
              <div style="font-size: 11px; font-weight: 600; color: #f59e0b;">Orange Zone</div>
              <div style="font-size: 10px; color: #64748b;">-10% bis -20%</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; padding: 8px; background: rgba(239, 68, 68, 0.1); 
                        border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="zone-red" style="margin-right: 8px;" />
            <div>
              <div style="font-size: 11px; font-weight: 600; color: #ef4444;">Rote Zone</div>
              <div style="font-size: 10px; color: #64748b;">-20% bis -30%</div>
            </div>
          </label>
        </div>
        
        <div class="section-title" style="margin-top: 16px;">Vorteilsbereiche</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <div style="font-size: 11px; color: #10b981; margin-bottom: 8px;">Long Bereich</div>
            <div class="form-row" style="grid-template-columns: 60px 1fr;">
              <label class="form-label">Min</label>
              <input type="number" class="form-input" id="strategy-long-min" placeholder="z.B. 33" />
            </div>
            <div class="form-row" style="grid-template-columns: 60px 1fr;">
              <label class="form-label">Max</label>
              <input type="number" class="form-input" id="strategy-long-max" placeholder="z.B. 100" />
            </div>
          </div>
          <div>
            <div style="font-size: 11px; color: #ef4444; margin-bottom: 8px;">Short Bereich</div>
            <div class="form-row" style="grid-template-columns: 60px 1fr;">
              <label class="form-label">Min</label>
              <input type="number" class="form-input" id="strategy-short-min" placeholder="z.B. -100" />
            </div>
            <div class="form-row" style="grid-template-columns: 60px 1fr;">
              <label class="form-label">Max</label>
              <input type="number" class="form-input" id="strategy-short-max" placeholder="z.B. -33" />
            </div>
          </div>
        </div>
        
        <div class="form-row" style="margin-top: 16px;">
          <label class="form-label">RRR Target</label>
          <input type="text" class="form-input" id="strategy-rrr" placeholder="1.5 - 3.0" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="save-button" onclick="saveStrategy()">Speichern</button>
      </div>
    </div>
  </div>
  
  <!-- Trade Edit Modal -->
  <div class="modal" id="trade-modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Trade Details</h2>
        <button class="modal-close" onclick="closeModal('trade-modal')">×</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label class="form-label">Trade ID</label>
          <input type="text" class="form-input" id="trade-id" readonly disabled />
        </div>
        
        <div class="form-row">
          <label class="form-label">Account</label>
          <select class="form-select" id="trade-account">
            <!-- Will be populated with accounts -->
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Instrument</label>
          <input type="text" class="form-input" id="trade-instrument" placeholder="z.B. FDAX" />
        </div>
        
        <div class="form-row">
          <label class="form-label">Währung</label>
          <select class="form-select" id="trade-currency">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
            <option value="JPY">JPY</option>
            <option value="CHF">CHF</option>
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Richtung</label>
          <select class="form-select" id="trade-direction">
            <option value="LONG">LONG</option>
            <option value="SHORT">SHORT</option>
          </select>
        </div>
        
        <div class="section-title">Einstiege</div>
        <div id="entry-points-container">
          <!-- Entry points will be added here -->
        </div>
        <button class="btn btn-secondary btn-small" onclick="addEntryPoint()">+ Einstieg hinzufügen</button>
        
        <div class="section-title" style="margin-top: 16px;">Ausstiege</div>
        <div id="exit-points-container">
          <!-- Exit points will be added here -->
        </div>
        <button class="btn btn-secondary btn-small" onclick="addExitPoint()">+ Ausstieg hinzufügen</button>
        
        <div class="form-row" style="margin-top: 16px;">
          <label class="form-label">Initial Stop</label>
          <input type="number" class="form-input" id="trade-initial-stop" step="0.01" placeholder="Stop Loss Preis" />
        </div>
        
        <div class="form-row">
          <label class="form-label">Strategy</label>
          <select class="form-select" id="trade-strategy">
            <!-- Will be populated with strategies -->
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Management</label>
          <textarea class="form-input" id="trade-management" rows="3" 
                    placeholder="Trade Management Details"></textarea>
        </div>
        
        <div class="form-row">
          <label class="form-label">Fehler</label>
          <textarea class="form-input" id="trade-errors" rows="3" 
                    placeholder="Fehler und Learnings aus diesem Trade"></textarea>
        </div>
        
        <div class="form-row">
          <label class="form-label">Status</label>
          <select class="form-select" id="trade-status">
            <option value="Open">Open</option>
            <option value="Closed">Closed</option>
            <option value="Partial">Partial</option>
          </select>
        </div>
        
        <div class="form-row">
          <label class="form-label">Screenshots</label>
          <input type="file" class="form-input" id="trade-screenshots" multiple accept="image/*" onchange="handleScreenshots(event)" />
          <div id="screenshot-preview" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="save-button" onclick="saveTrade()">Speichern</button>
        <button class="btn btn-secondary" onclick="closeModal('trade-modal')">Abbrechen</button>
      </div>
    </div>
  </div>
  
  <!-- End of Modals -->
  </div> <!-- End app-wrapper -->
  
  <script>
// Alle Funktionen global verfügbar machen - NUR wenn sie existieren
const functionsToGlobalize = [
  'editAccount', 'deleteAccount', 'editTrade', 'deleteTrade',
  'openAccountModal', 'openStrategyModal', 'openTradeModal', 'closeModal',
  'saveAccount', 'saveStrategy', 'saveTrade', 'setMainAccount',
  'addEntryPoint', 'addExitPoint', 'selectStrategy', 'setGear', 'setRisk',
  'calculateAll', 'saveAnalysisToDashboard', 'updateInstruments',
  'updateMAInstruments', 'syncInstrumentToRisk', 'updateAccountBalance',
  'calculatePosition', 'executeAction', 'addToTradeLog', 'switchModule',
  'exportTrades', 'updateAggressivenessDisplay', 'handleScreenshots',
  'openTransactionModal', 'saveTransaction', 'deleteTransactionAndRefresh',
  'openTransactionModalForAccount'
];

functionsToGlobalize.forEach(function(funcName) {
  try {
    if (typeof window[funcName] === 'undefined' && typeof eval(funcName) === 'function') {
      window[funcName] = eval(funcName);
    }
  } catch(e) {
    // Funktion existiert nicht, das ist ok
  }
});

// Initialize the application when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('TraceVizion Pro wird initialisiert...');
  
  // Initialize the app
  init();
  initializeMobileMenu();
  
  
  console.log('Strategien geladen:', strategies);
  console.log('TraceVizion Pro erfolgreich initialisiert!');
  
  // Test ob Funktionen verfügbar sind
  console.log('window.editStrategy verfügbar:', typeof window.editStrategy);
  console.log('window.deleteStrategy verfügbar:', typeof window.deleteStrategy);
});
  </script>
</body>
</html>
